<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ VoidCore Phase 5.2 - Dynamic Plugin Demo (Fixed Initialization)</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .demo-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 2px;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 2px solid #4a90e2;
        }

        .header h1 {
            font-size: 18px;
            color: #4a90e2;
        }

        .main-area {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            overflow-y: auto;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-left: 1px solid #333;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 30px;
        }

        .control-title {
            font-size: 14px;
            color: #4a90e2;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .button {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 12px;
        }

        .button:hover {
            background: #357abd;
            transform: translateY(-2px);
        }

        .button.danger {
            background: #e74c3c;
        }

        .button.danger:hover {
            background: #c0392b;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: #bbb;
            margin-bottom: 5px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-family: inherit;
            font-size: 12px;
        }

        #log {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.4;
        }

        .plugin-list {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .plugin-item {
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            font-size: 11px;
        }

        .plugin-type {
            color: #4a90e2;
            font-weight: bold;
        }

        .plugin-id {
            color: #bbb;
            font-size: 10px;
        }

        .stats-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            font-size: 11px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .stats-label {
            color: #bbb;
        }

        .stats-value {
            color: #4a90e2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="header">
            <h1>ğŸš€ VoidCore Phase 5.2 - Dynamic Plugin Management Demo (Fixed)</h1>
        </div>
        
        <div class="main-area">
            <h2>ğŸ“Š System Log</h2>
            <div id="log"></div>
        </div>
        
        <div class="control-panel">
            <div class="control-section">
                <div class="control-title">ğŸš€ Plugin Creation</div>
                
                <div class="input-group">
                    <label>Plugin Type:</label>
                    <select id="pluginType">
                        <option value="test.simple">test.simple</option>
                        <option value="game.enemy">game.enemy</option>
                        <option value="game.player">game.player</option>
                        <option value="core.manager">core.manager</option>
                        <option value="util.logger">util.logger</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Display Name (ChatGPTæ¡ˆ):</label>
                    <input type="text" id="displayName" placeholder="ä¾‹: logger42, enemy1, boss-core">
                </div>
                
                <div class="input-group">
                    <label>Parent Plugin ID:</label>
                    <input type="text" id="parentId" placeholder="Leave empty for root">
                </div>
                
                <div class="input-group">
                    <label>Max Depth:</label>
                    <input type="number" id="maxDepth" value="5" min="1" max="20">
                </div>
                
                <div class="input-group">
                    <label>Resource Cost:</label>
                    <input type="number" id="resourceCost" value="1" min="1" max="10">
                </div>
                
                <button class="button" onclick="createDynamicPlugin()">ğŸš€ Create Plugin</button>
            </div>
            
            <div class="control-section">
                <div class="control-title">ğŸ—‘ï¸ Plugin Management</div>
                
                <div class="input-group">
                    <label>Plugin ID to Delete:</label>
                    <input type="text" id="deletePluginId" placeholder="plugin-id">
                </div>
                
                <button class="button danger" onclick="destroyDynamicPlugin()">ğŸ—‘ï¸ Delete Plugin</button>
            </div>
            
            <div class="control-section">
                <div class="control-title">ğŸ˜ï¸ æˆ¸ç±ç•°å‹•å±Š (ChatGPTæ¡ˆ)</div>
                
                <div class="input-group">
                    <label>ç§»å‹•ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ID:</label>
                    <input type="text" id="reparentPluginId" placeholder="plugin-id">
                </div>
                
                <div class="input-group">
                    <label>æ–°ã—ã„è¦ªID:</label>
                    <input type="text" id="newParentId" placeholder="æ–°ã—ã„è¦ªã®ID (ç©ºã§æœ€ä¸Šä½)">
                </div>
                
                <div class="input-group">
                    <label>ç¾åœ¨ã®è¦ªID (ç¢ºèªç”¨):</label>
                    <input type="text" id="oldParentId" placeholder="çœç•¥å¯ãƒ»ç¢ºèªç”¨">
                </div>
                
                <button class="button" onclick="reparentPlugin()">ğŸ˜ï¸ æˆ¸ç±ç•°å‹•å®Ÿè¡Œ</button>
            </div>
            
            <div class="control-section">
                <div class="control-title">ğŸ”— Connection</div>
                
                <div class="input-group">
                    <label>Source Plugin:</label>
                    <input type="text" id="sourcePlugin" placeholder="source-plugin-id">
                </div>
                
                <div class="input-group">
                    <label>Target Plugin:</label>
                    <input type="text" id="targetPlugin" placeholder="target-plugin-id">
                </div>
                
                <button class="button" onclick="connectDynamicPlugins()">ğŸ”— Connect</button>
            </div>
            
            <div class="control-section">
                <div class="control-title">ğŸ“Š System Stats</div>
                <div class="stats-panel" id="statsPanel">
                    <div class="stats-item">
                        <span class="stats-label">Total Plugins:</span>
                        <span class="stats-value" id="totalPlugins">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Dynamic Plugins:</span>
                        <span class="stats-value" id="dynamicPlugins">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Root Plugins:</span>
                        <span class="stats-value" id="rootPlugins">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Max Hierarchy:</span>
                        <span class="stats-value" id="maxHierarchy">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Pending Requests:</span>
                        <span class="stats-value" id="pendingRequests">0</span>
                    </div>
                </div>
                
                <button class="button" onclick="updateStats()">ğŸ“Š Refresh Stats</button>
                <button class="button" onclick="validateHierarchy()">ğŸ” Validate Hierarchy</button>
            </div>
            
            <div class="control-section">
                <div class="control-title">ğŸ“‹ Active Plugins</div>
                <div class="plugin-list" id="pluginList">
                    <div class="plugin-item">No plugins created yet</div>
                </div>
                
                <button class="button" onclick="updatePluginList()">ğŸ“‹ Refresh List</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { voidCore, createPlugin, spawnPlugin, destroyPlugin, connectPlugins, getSystemStats } from '../src/pure_plugin_system.js';

        // ãƒ­ã‚°è¦ç´ ã®è¨­å®š
        voidCore.setLogElement(document.getElementById('log'));

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
        window.voidCore = voidCore;
        window.createDynamicPlugin = createDynamicPlugin;
        window.destroyDynamicPlugin = destroyDynamicPlugin;
        window.reparentPlugin = reparentPlugin;
        window.connectDynamicPlugins = connectDynamicPlugins;
        window.updateStats = updateStats;
        window.updatePluginList = updatePluginList;
        window.validateHierarchy = validateHierarchy;

        // ğŸš€ å‹•çš„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ
        async function createDynamicPlugin() {
            const type = document.getElementById('pluginType').value;
            const displayName = document.getElementById('displayName').value.trim();
            const parentId = document.getElementById('parentId').value.trim();
            const maxDepth = parseInt(document.getElementById('maxDepth').value);
            const resourceCost = parseInt(document.getElementById('resourceCost').value);

            try {
                const correlationId = `demo-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
                
                const payload = {
                    type,
                    displayName: displayName || null,  // ChatGPTæ¡ˆ: displayNameè¿½åŠ 
                    config: {
                        demoMode: true,
                        createdBy: 'demo-interface'
                    },
                    parent: parentId || null,
                    correlationId,
                    maxDepth,
                    resourceCost
                };

                // ç›´æ¥IntentRequestã‚’é€ä¿¡
                await voidCore.publish({
                    type: 'IntentRequest',
                    action: 'system.createPlugin',
                    payload,
                    timestamp: Date.now()
                });

                voidCore.log(`ğŸ“¤ Plugin creation request sent: ${type}`);
                
                // UIæ›´æ–°
                setTimeout(() => {
                    updateStats();
                    updatePluginList();
                }, 500);

            } catch (error) {
                voidCore.log(`âŒ Plugin creation failed: ${error.message}`);
            }
        }

        // ğŸ—‘ï¸ å‹•çš„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å‰Šé™¤
        async function destroyDynamicPlugin() {
            const pluginId = document.getElementById('deletePluginId').value.trim();
            
            if (!pluginId) {
                voidCore.log('âš ï¸ Please enter a plugin ID to delete');
                return;
            }

            try {
                const correlationId = `destroy-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
                
                await voidCore.publish({
                    type: 'IntentRequest',
                    action: 'system.destroyPlugin',
                    payload: {
                        pluginId,
                        correlationId
                    },
                    timestamp: Date.now()
                });

                voidCore.log(`ğŸ“¤ Plugin destruction request sent: ${pluginId}`);
                
                // UIæ›´æ–°
                setTimeout(() => {
                    updateStats();
                    updatePluginList();
                }, 500);

            } catch (error) {
                voidCore.log(`âŒ Plugin destruction failed: ${error.message}`);
            }
        }

        // ğŸ˜ï¸ æˆ¸ç±ç•°å‹•å±Š (ChatGPTæ¡ˆ) - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¦ªå­é–¢ä¿‚å¤‰æ›´
        async function reparentPlugin() {
            const pluginId = document.getElementById('reparentPluginId').value.trim();
            const newParentId = document.getElementById('newParentId').value.trim();
            const oldParentId = document.getElementById('oldParentId').value.trim();
            
            if (!pluginId) {
                voidCore.log('âš ï¸ Please enter a plugin ID to reparent');
                return;
            }

            try {
                const correlationId = `reparent-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
                
                const payload = {
                    pluginId,
                    newParentId: newParentId || null,  // ç©ºæ–‡å­—åˆ—ã¯nullã«å¤‰æ›
                    oldParentId: oldParentId || null,  // ç¢ºèªç”¨ï¼ˆçœç•¥å¯ï¼‰
                    correlationId
                };

                // system.reparentPlugin IntentRequesté€ä¿¡
                await voidCore.publish({
                    type: 'IntentRequest',
                    action: 'system.reparentPlugin',
                    payload,
                    timestamp: Date.now()
                });

                voidCore.log(`ğŸ“¤ Plugin reparenting request sent: ${pluginId} -> ${newParentId || 'root'}`);
                
                // UIæ›´æ–°
                setTimeout(() => {
                    updateStats();
                    updatePluginList();
                }, 500);

            } catch (error) {
                voidCore.log(`âŒ Plugin reparenting failed: ${error.message}`);
            }
        }

        // ğŸ”— å‹•çš„æ¥ç¶š
        async function connectDynamicPlugins() {
            const source = document.getElementById('sourcePlugin').value.trim();
            const target = document.getElementById('targetPlugin').value.trim();
            
            if (!source || !target) {
                voidCore.log('âš ï¸ Please enter both source and target plugin IDs');
                return;
            }

            try {
                const correlationId = `connect-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
                
                await voidCore.publish({
                    type: 'IntentRequest',
                    action: 'system.connect',
                    payload: {
                        source,
                        target,
                        sourcePort: 'output',
                        targetPort: 'input',
                        correlationId
                    },
                    timestamp: Date.now()
                });

                voidCore.log(`ğŸ“¤ Connection request sent: ${source} -> ${target}`);

            } catch (error) {
                voidCore.log(`âŒ Connection failed: ${error.message}`);
            }
        }

        // ğŸ“Š çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const stats = getSystemStats();
            
            document.getElementById('totalPlugins').textContent = stats.pluginCount || 0;
            document.getElementById('dynamicPlugins').textContent = stats.dynamicPlugins || 0;
            document.getElementById('rootPlugins').textContent = stats.hierarchyStats?.rootPlugins || 0;
            document.getElementById('maxHierarchy').textContent = stats.hierarchyStats?.maxHierarchyLevel || 0;
            document.getElementById('pendingRequests').textContent = stats.pendingRequests || 0;
            
            voidCore.log(`ğŸ“Š Stats updated: ${stats.pluginCount} plugins, ${stats.dynamicPlugins} dynamic, hierarchy: ${stats.hierarchyStats?.maxHierarchyLevel || 0}`);
        }
        
        // ğŸ” éšå±¤æ§‹é€ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        function validateHierarchy() {
            const validation = voidCore.validateHierarchyIntegrity();
            
            if (validation.isValid) {
                voidCore.log('âœ… Hierarchy validation passed - No issues found');
            } else {
                voidCore.log(`âŒ Hierarchy validation failed - ${validation.issues.length} issues found:`);
                validation.issues.forEach(issue => {
                    voidCore.log(`   ${issue.type}: ${issue.message}`);
                });
            }
            
            return validation;
        }

        // ğŸ“‹ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆéšå±¤æ§‹é€ å¯¾å¿œï¼‰
        function updatePluginList() {
            const plugins = voidCore.getAllPlugins();
            const listElement = document.getElementById('pluginList');
            
            if (plugins.length === 0) {
                listElement.innerHTML = '<div class="plugin-item">No plugins created yet</div>';
                return;
            }
            
            // éšå±¤æ§‹é€ ã§ã‚½ãƒ¼ãƒˆ
            const pluginTree = voidCore.getPluginTree();
            
            const renderPlugin = (plugin, level = 0) => {
                const displayLabel = voidCore.getPluginLabel(plugin);
                const indent = '&nbsp;&nbsp;'.repeat(level * 2);
                const levelIndicator = level > 0 ? `L${level}` : 'ROOT';
                const children = voidCore.getChildren(plugin.pluginId);
                
                let html = `
                <div class="plugin-item" style="margin-left: ${level * 15}px; ${level > 0 ? 'border-left: 2px solid #333;' : ''}">
                    <div class="plugin-type">
                        ${indent}${levelIndicator} ${plugin.type || 'unknown'}
                        ${children.length > 0 ? ` (${children.length} children)` : ''}
                    </div>
                    <div class="plugin-id">
                        <strong>${displayLabel}</strong>
                        ${plugin.displayName ? `<div style="color: #888; font-size: 10px;">(${plugin.pluginId})</div>` : ''}
                    </div>
                    ${plugin.parentId ? `<div style="color: #888; font-size: 10px;">Parent: ${voidCore.getPluginLabel(voidCore.getPlugin(plugin.parentId))}</div>` : ''}
                    ${plugin.metadata?.correlationId ? `<div style="color: #4a90e2; font-size: 10px;">Dynamic (${plugin.metadata.correlationId})</div>` : ''}
                </div>
                `;
                
                // å­ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å†å¸°çš„ã«è¡¨ç¤º
                if (plugin.children) {
                    plugin.children.forEach(child => {
                        html += renderPlugin(child, level + 1);
                    });
                }
                
                return html;
            };
            
            let html = '';
            pluginTree.forEach(rootPlugin => {
                html += renderPlugin(rootPlugin, 0);
            });
            
            listElement.innerHTML = html;
            
            const hierarchyStats = voidCore.getSystemStats().hierarchyStats;
            voidCore.log(`ğŸ“‹ Plugin list updated: ${plugins.length} total, ${hierarchyStats.rootPlugins} roots, max level: ${hierarchyStats.maxHierarchyLevel}`);
        }

        // åˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆ: éåŒæœŸå¯¾å¿œï¼‰
        async function initializeDemo() {
            voidCore.log('ğŸš€ VoidCore Phase 5.2 Dynamic Plugin Demo initialized (Fixed Version)');
            voidCore.log('ğŸ’¡ Use the controls on the right to create and manage plugins dynamically');
            voidCore.log('ğŸ¯ Try creating a few plugins and watch the system statistics');
            
            // åˆæœŸçµ±è¨ˆæ›´æ–°
            updateStats();
            updatePluginList();

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç›£è¦–ï¼ˆä¿®æ­£ç‰ˆ: async/awaitå¯¾å¿œï¼‰
            const unsubscribeResponseMonitor = voidCore.subscribe('IntentResponse', (message) => {
                if (message.action && message.action.startsWith('system.')) {
                    voidCore.log(`ğŸ“¨ System response: ${message.action} - ${message.payload.success ? 'âœ… Success' : 'âŒ Failed'}`);
                    if (!message.payload.success) {
                        voidCore.log(`   Error: ${message.payload.error}`);
                    }
                }
            });
            
            voidCore.log('âœ… Demo initialization completed - Ready for plugin management!');
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        initializeDemo().catch(error => {
            console.error('Demo initialization failed:', error);
            voidCore.log(`âŒ Demo initialization failed: ${error.message}`);
        });
    </script>
</body>
</html>