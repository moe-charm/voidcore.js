// plugin-loader.js - ÊÆµÈöéÁöÑ„Éó„É©„Ç∞„Ç§„É≥Ë™≠„ÅøËæº„Åø„Ç∑„Çπ„ÉÜ„É†
// 1000+„Éó„É©„Ç∞„Ç§„É≥„Åß„ÇÇ„Çπ„É†„Éº„Ç∫„Å´Âãï‰Ωú„Åô„ÇãÈ´òÊÄßËÉΩ„É≠„Éº„ÉÄ„Éº

import { PluginAttributes } from './plugin-attributes.js'

/**
 * üöÄ PluginLoader - ÊÆµÈöéÁöÑ„Éó„É©„Ç∞„Ç§„É≥Ë™≠„ÅøËæº„Åø„Ç∑„Çπ„ÉÜ„É†
 * 
 * 1000+„Éó„É©„Ç∞„Ç§„É≥„ÇíÂäπÁéáÁöÑ„Å´Ë™≠„ÅøËæº„Åø„ÉªÁÆ°ÁêÜ„Åô„Çã„Åü„ÇÅ„ÅÆ„É≠„Éº„ÉÄ„Éº
 * - ÊÆµÈöéÁöÑË™≠„ÅøËæº„ÅøÔºàLazy LoadingÔºâ
 * - ‰ªÆÊÉ≥ÂåñÔºàVirtualizationÔºâ
 * - ÂÑ™ÂÖàÂ∫¶Âà∂Âæ°
 * - „Ç≠„É£„ÉÉ„Ç∑„É•Ê©üËÉΩ
 * - „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâË™≠„ÅøËæº„Åø
 * - „Éó„É™„Éï„Çß„ÉÉ„ÉÅÊ©üËÉΩ
 */
export class PluginLoader {
  constructor(voidCoreUI) {
    this.voidCoreUI = voidCoreUI
    this.version = '1.0.0'
    
    // Ë™≠„ÅøËæº„ÅøÁä∂ÊÖãÁÆ°ÁêÜ
    this.loadingState = {
      total: 0,
      loaded: 0,
      loading: 0,
      cached: 0,
      error: 0
    }
    
    // Ë™≠„ÅøËæº„ÅøË®≠ÂÆö
    this.config = {
      batchSize: 20,           // 1Âõû„ÅÆË™≠„ÅøËæº„ÅøÊï∞
      maxConcurrent: 5,        // ÂêåÊôÇË™≠„ÅøËæº„ÅøÊï∞
      cacheSize: 100,          // „Ç≠„É£„ÉÉ„Ç∑„É•„Çµ„Ç§„Ç∫
      preloadDistance: 50,     // „Éó„É™„É≠„Éº„ÉâË∑ùÈõ¢
      loadTimeout: 10000,      // Ë™≠„ÅøËæº„Åø„Çø„Ç§„É†„Ç¢„Ç¶„Éà
      retryAttempts: 3,        // „É™„Éà„É©„Ç§ÂõûÊï∞
      enableVirtualization: true,
      enablePrefetch: true,
      enableBackgroundLoading: true
    }
    
    // „Éó„É©„Ç∞„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä
    this.pluginRegistry = new Map()    // pluginId ‚Üí plugin data
    this.pluginCache = new Map()       // pluginId ‚Üí loaded plugin
    this.pluginQueue = []              // Ë™≠„ÅøËæº„ÅøÂæÖÊ©ü„Ç≠„É•„Éº
    this.loadingPlugins = new Set()    // Ë™≠„ÅøËæº„Åø‰∏≠„Éó„É©„Ç∞„Ç§„É≥
    
    // Ë™≠„ÅøËæº„ÅøÁä∂ÊÖã
    this.isLoading = false
    this.loadingPromises = new Map()
    
    // Áµ±Ë®àÊÉÖÂ†±
    this.stats = {
      totalLoadTime: 0,
      averageLoadTime: 0,
      cacheHitRate: 0,
      errorRate: 0,
      loadHistory: []
    }
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    this.eventListeners = {
      'plugin.loaded': [],
      'plugin.loading': [],
      'plugin.error': [],
      'batch.loaded': [],
      'loading.complete': []
    }
    
    this.log('üöÄ PluginLoader initialized')
  }
  
  log(message) {
    console.log(`[PluginLoader] ${message}`)
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„ÅÆÁôªÈå≤
   */
  registerPlugin(pluginId, pluginData) {
    if (this.pluginRegistry.has(pluginId)) {
      this.log(`‚ö†Ô∏è Plugin ${pluginId} already registered, updating...`)
    }
    
    const registryEntry = {
      id: pluginId,
      data: pluginData,
      priority: pluginData.attributes?.priority || 'medium',
      loaded: false,
      cached: false,
      error: null,
      loadTime: null,
      lastAccessed: null
    }
    
    this.pluginRegistry.set(pluginId, registryEntry)
    this.updateLoadingState()
    
    this.log(`üì¶ Plugin registered: ${pluginId}`)
  }
  
  /**
   * Ë§áÊï∞„Éó„É©„Ç∞„Ç§„É≥„ÅÆ‰∏ÄÊã¨ÁôªÈå≤
   */
  registerMultiplePlugins(plugins) {
    plugins.forEach(plugin => {
      this.registerPlugin(plugin.id, plugin)
    })
    
    this.log(`üì¶ ${plugins.length} plugins registered`)
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„ÅÆÊÆµÈöéÁöÑË™≠„ÅøËæº„Åø
   */
  async loadPlugins(options = {}) {
    const config = { ...this.config, ...options }
    
    this.log(`üöÄ Starting staged plugin loading (${this.pluginRegistry.size} plugins)`)
    
    // Ë™≠„ÅøËæº„ÅøÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
    this.loadingState.loaded = 0
    this.loadingState.loading = 0
    this.loadingState.error = 0
    this.loadingState.total = this.pluginRegistry.size
    
    // ÂÑ™ÂÖàÂ∫¶È†Ü„Å´„ÇΩ„Éº„Éà
    const sortedPlugins = this.getSortedPlugins()
    
    // ÊÆµÈöéÁöÑË™≠„ÅøËæº„ÅøÈñãÂßã
    await this.loadPluginsInBatches(sortedPlugins, config)
    
    this.log(`‚úÖ Plugin loading completed: ${this.loadingState.loaded}/${this.loadingState.total}`)
    this.emit('loading.complete', this.loadingState)
  }
  
  /**
   * ÂÑ™ÂÖàÂ∫¶È†Ü„Å´„Éó„É©„Ç∞„Ç§„É≥„ÇíÂèñÂæó
   */
  getSortedPlugins() {
    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 }
    
    return Array.from(this.pluginRegistry.values())
      .sort((a, b) => {
        const priorityA = priorityOrder[a.priority] || 1
        const priorityB = priorityOrder[b.priority] || 1
        return priorityA - priorityB
      })
  }
  
  /**
   * „Éê„ÉÉ„ÉÅÂçò‰Ωç„Åß„Éó„É©„Ç∞„Ç§„É≥„ÇíË™≠„ÅøËæº„Åø
   */
  async loadPluginsInBatches(plugins, config) {
    const batches = this.createBatches(plugins, config.batchSize)
    
    for (let i = 0; i < batches.length; i++) {
      const batch = batches[i]
      
      this.log(`üì¶ Loading batch ${i + 1}/${batches.length} (${batch.length} plugins)`)
      
      // „Éê„ÉÉ„ÉÅË™≠„ÅøËæº„Åø
      await this.loadPluginBatch(batch, config)
      
      // UI„ÅÆÊõ¥Êñ∞
      this.emit('batch.loaded', {
        batchIndex: i,
        totalBatches: batches.length,
        loadedPlugins: batch.length,
        totalLoaded: this.loadingState.loaded
      })
      
      // Ê¨°„ÅÆ„Éê„ÉÉ„ÉÅ„Åæ„ÅßÂ∞ë„ÅóÂæÖÊ©üÔºàUI„ÅÆÂøúÁ≠îÊÄßÂêë‰∏äÔºâ
      if (i < batches.length - 1) {
        await this.delay(50)
      }
    }
  }
  
  /**
   * „Éê„ÉÉ„ÉÅ„Çí„Éó„É©„Ç∞„Ç§„É≥„É™„Çπ„Éà„Åã„Çâ‰ΩúÊàê
   */
  createBatches(plugins, batchSize) {
    const batches = []
    
    for (let i = 0; i < plugins.length; i += batchSize) {
      batches.push(plugins.slice(i, i + batchSize))
    }
    
    return batches
  }
  
  /**
   * 1„Å§„ÅÆ„Éê„ÉÉ„ÉÅ„ÇíË™≠„ÅøËæº„Åø
   */
  async loadPluginBatch(batch, config) {
    const loadPromises = batch.map(async (pluginEntry) => {
      try {
        await this.loadSinglePlugin(pluginEntry.id, config)
      } catch (error) {
        this.log(`‚ùå Failed to load plugin: ${pluginEntry.id}`)
        this.handlePluginError(pluginEntry.id, error)
      }
    })
    
    await Promise.all(loadPromises)
  }
  
  /**
   * Âçò‰∏Ä„Éó„É©„Ç∞„Ç§„É≥„ÅÆË™≠„ÅøËæº„Åø
   */
  async loadSinglePlugin(pluginId, config) {
    const startTime = Date.now()
    
    // Êó¢„Å´Ë™≠„ÅøËæº„ÅøÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if (this.pluginCache.has(pluginId)) {
      this.updateCacheHit(pluginId)
      return this.pluginCache.get(pluginId)
    }
    
    // Ë™≠„ÅøËæº„Åø‰∏≠„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if (this.loadingPlugins.has(pluginId)) {
      return this.waitForLoading(pluginId)
    }
    
    this.loadingPlugins.add(pluginId)
    this.loadingState.loading++
    
    try {
      this.emit('plugin.loading', { pluginId })
      
      const pluginEntry = this.pluginRegistry.get(pluginId)
      if (!pluginEntry) {
        throw new Error(`Plugin ${pluginId} not found in registry`)
      }
      
      // „Éó„É©„Ç∞„Ç§„É≥„ÅÆ„Éá„Ç∑„É™„Ç¢„É©„Ç§„Çº„Éº„Ç∑„Éß„É≥„ÉªÂàùÊúüÂåñ
      const plugin = await this.initializePlugin(pluginEntry.data)
      
      // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
      this.pluginCache.set(pluginId, plugin)
      
      // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
      const loadTime = Date.now() - startTime
      this.updateLoadingStats(pluginId, loadTime)
      
      // UIÁôªÈå≤
      if (this.voidCoreUI) {
        this.voidCoreUI.registerPlugin(plugin)
      }
      
      this.log(`‚úÖ Plugin loaded: ${pluginId} (${loadTime}ms)`)
      this.emit('plugin.loaded', { pluginId, plugin, loadTime })
      
      return plugin
      
    } catch (error) {
      this.handlePluginError(pluginId, error)
      throw error
    } finally {
      this.loadingPlugins.delete(pluginId)
      this.loadingState.loading--
    }
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„ÅÆÂàùÊúüÂåñ
   */
  async initializePlugin(pluginData) {
    // „Éó„É©„Ç∞„Ç§„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÊßãÁØâ
    const plugin = {
      id: pluginData.id,
      displayName: pluginData.displayName || pluginData.id,
      version: pluginData.version || '1.0.0',
      type: pluginData.type || 'custom',
      attributes: pluginData.attributes ? 
        new PluginAttributes(pluginData.attributes) : 
        new PluginAttributes()
    }
    
    // „ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆÂÆüË°å
    if (pluginData.sourceCode) {
      try {
        await this.executePluginCode(plugin, pluginData.sourceCode)
      } catch (error) {
        this.log(`‚ö†Ô∏è Plugin code execution failed: ${plugin.id}`)
        plugin.executionError = error
      }
    }
    
    return plugin
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„Ç≥„Éº„Éâ„ÅÆÂÆüË°å
   */
  async executePluginCode(plugin, sourceCode) {
    // ÂÆâÂÖ®„Å™ÂÆüË°åÁí∞Â¢É„Çí‰ΩúÊàê
    const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor
    
    try {
      const pluginFunction = new AsyncFunction(
        'plugin',
        'voidCore',
        'createPlugin',
        'createComfortablePlugin',
        sourceCode
      )
      
      // „Éó„É©„Ç∞„Ç§„É≥„Ç≥„Éº„Éâ„ÇíÂÆüË°å
      const result = await pluginFunction(
        plugin,
        this.voidCoreUI?.voidCore,
        window.createPlugin,
        window.createComfortablePlugin
      )
      
      // ÁµêÊûú„Çí„Éó„É©„Ç∞„Ç§„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Áµ±Âêà
      if (result && typeof result === 'object') {
        Object.assign(plugin, result)
      }
      
    } catch (error) {
      this.log(`‚ùå Plugin code execution error: ${plugin.id}`)
      throw error
    }
  }
  
  /**
   * Ë™≠„ÅøËæº„ÅøÂæÖÊ©ü
   */
  async waitForLoading(pluginId) {
    return new Promise((resolve, reject) => {
      const checkInterval = setInterval(() => {
        if (this.pluginCache.has(pluginId)) {
          clearInterval(checkInterval)
          resolve(this.pluginCache.get(pluginId))
        } else if (!this.loadingPlugins.has(pluginId)) {
          clearInterval(checkInterval)
          reject(new Error(`Plugin ${pluginId} loading failed`))
        }
      }, 100)
    })
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„Ç®„É©„ÉºÂá¶ÁêÜ
   */
  handlePluginError(pluginId, error) {
    this.loadingState.error++
    
    const pluginEntry = this.pluginRegistry.get(pluginId)
    if (pluginEntry) {
      pluginEntry.error = error
    }
    
    this.log(`‚ùå Plugin error: ${pluginId} - ${error.message}`)
    this.emit('plugin.error', { pluginId, error })
  }
  
  /**
   * Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
   */
  updateLoadingStats(pluginId, loadTime) {
    this.loadingState.loaded++
    
    const pluginEntry = this.pluginRegistry.get(pluginId)
    if (pluginEntry) {
      pluginEntry.loaded = true
      pluginEntry.loadTime = loadTime
      pluginEntry.lastAccessed = Date.now()
    }
    
    this.stats.totalLoadTime += loadTime
    this.stats.averageLoadTime = this.stats.totalLoadTime / this.loadingState.loaded
    this.stats.loadHistory.push({ pluginId, loadTime, timestamp: Date.now() })
    
    // Â±•Ê≠¥„Çµ„Ç§„Ç∫Âà∂Èôê
    if (this.stats.loadHistory.length > 1000) {
      this.stats.loadHistory.splice(0, 100)
    }
  }
  
  /**
   * „Ç≠„É£„ÉÉ„Ç∑„É•„Éí„ÉÉ„ÉàÊõ¥Êñ∞
   */
  updateCacheHit(pluginId) {
    const pluginEntry = this.pluginRegistry.get(pluginId)
    if (pluginEntry) {
      pluginEntry.lastAccessed = Date.now()
    }
    
    this.stats.cacheHitRate = this.loadingState.cached / 
      (this.loadingState.loaded + this.loadingState.cached)
  }
  
  /**
   * Ë™≠„ÅøËæº„ÅøÁä∂ÊÖãÊõ¥Êñ∞
   */
  updateLoadingState() {
    this.loadingState.total = this.pluginRegistry.size
    this.loadingState.cached = this.pluginCache.size
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥„Ç¢„É≥„É≠„Éº„ÉâÔºà„É°„É¢„É™ÁÆ°ÁêÜÔºâ
   */
  unloadPlugin(pluginId) {
    if (this.pluginCache.has(pluginId)) {
      this.pluginCache.delete(pluginId)
      this.log(`üóëÔ∏è Plugin unloaded: ${pluginId}`)
    }
    
    if (this.voidCoreUI) {
      this.voidCoreUI.unregisterPlugin(pluginId)
    }
  }
  
  /**
   * „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
   */
  clearCache() {
    this.pluginCache.clear()
    this.loadingState.cached = 0
    this.log('üóëÔ∏è Plugin cache cleared')
  }
  
  /**
   * ÂÑ™ÂÖàÂ∫¶ÊåáÂÆöË™≠„ÅøËæº„Åø
   */
  async loadPluginsByPriority(priority) {
    const plugins = Array.from(this.pluginRegistry.values())
      .filter(p => p.priority === priority && !p.loaded)
    
    this.log(`üî• Loading ${plugins.length} ${priority} priority plugins`)
    
    await this.loadPluginsInBatches(plugins, this.config)
  }
  
  /**
   * ÈÅÖÂª∂ÂÆüË°å
   */
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms))
  }
  
  /**
   * „Ç§„Éô„É≥„Éà„Ç®„Éü„ÉÉ„Çø„Éº
   */
  emit(eventName, data) {
    const listeners = this.eventListeners[eventName] || []
    listeners.forEach(listener => {
      try {
        listener(data)
      } catch (error) {
        this.log(`‚ùå Event listener error: ${eventName}`)
      }
    })
  }
  
  /**
   * „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
   */
  on(eventName, listener) {
    if (!this.eventListeners[eventName]) {
      this.eventListeners[eventName] = []
    }
    this.eventListeners[eventName].push(listener)
  }
  
  /**
   * „Éó„É©„Ç∞„Ç§„É≥Ê§úÁ¥¢
   */
  searchPlugins(query) {
    const results = []
    
    this.pluginRegistry.forEach((pluginEntry, pluginId) => {
      const plugin = pluginEntry.data
      
      if (
        pluginId.toLowerCase().includes(query.toLowerCase()) ||
        plugin.displayName?.toLowerCase().includes(query.toLowerCase()) ||
        plugin.attributes?.tags?.some(tag => 
          tag.toLowerCase().includes(query.toLowerCase())
        )
      ) {
        results.push(pluginEntry)
      }
    })
    
    return results
  }
  
  /**
   * Áµ±Ë®àÊÉÖÂ†±ÂèñÂæó
   */
  getStats() {
    return {
      ...this.stats,
      loadingState: this.loadingState,
      cacheSize: this.pluginCache.size,
      registrySize: this.pluginRegistry.size
    }
  }
  
  /**
   * Ë®≠ÂÆöÊõ¥Êñ∞
   */
  updateConfig(newConfig) {
    this.config = { ...this.config, ...newConfig }
    this.log('‚öôÔ∏è Configuration updated')
  }
}

// „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ
export const pluginLoader = new PluginLoader()

console.log('üöÄ PluginLoader system loaded!')