<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Phase 5.2 Complete Test - æˆ¸ç±ç•°å‹•å±Šï¼†è¦ªå­é–¢ä¿‚API</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: linear-gradient(135deg, #0f3460, #16213e);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .test-section {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        
        .test-title {
            color: #4a90e2;
            font-size: 16px;
            margin-bottom: 15px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 5px;
        }
        
        .button {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
            font-size: 12px;
        }
        
        .button:hover {
            background: #357abd;
        }
        
        .button.success {
            background: #27ae60;
        }
        
        .button.danger {
            background: #e74c3c;
        }
        
        #log {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.4;
            grid-column: 1 / -1;
        }
        
        .result-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 5.2 å®Œå…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <div class="test-section">
            <div class="test-title">ğŸš€ åŸºæœ¬ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆãƒ†ã‚¹ãƒˆ</div>
            <button class="button" onclick="testBasicPluginCreation()">åŸºæœ¬ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ</button>
            <button class="button" onclick="testHierarchicalCreation()">éšå±¤ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ</button>
            <button class="button" onclick="testDisplayNamePlugins()">displayNameä»˜ããƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ</button>
            <div id="creationResults" class="result-box">çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ˜ï¸ æˆ¸ç±ç•°å‹•å±Šãƒ†ã‚¹ãƒˆ</div>
            <button class="button" onclick="testSimpleReparenting()">å˜ç´”ãªè¦ªå­ç§»å‹•</button>
            <button class="button" onclick="testRootToChild()">ãƒ«ãƒ¼ãƒˆâ†’å­ã¸ã®ç§»å‹•</button>
            <button class="button" onclick="testCircularPrevention()">å¾ªç’°å‚ç…§é˜²æ­¢ãƒ†ã‚¹ãƒˆ</button>
            <div id="reparentResults" class="result-box">çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ—ï¸ è¦ªå­é–¢ä¿‚APIãƒ†ã‚¹ãƒˆ</div>
            <button class="button" onclick="testGetChildren()">getChildren()</button>
            <button class="button" onclick="testGetDescendants()">getDescendants()</button>
            <button class="button" onclick="testGetAncestors()">getAncestors()</button>
            <button class="button" onclick="testGetPluginTree()">getPluginTree()</button>
            <div id="apiResults" class="result-box">çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ” æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</div>
            <button class="button" onclick="testHierarchyValidation()">éšå±¤æ§‹é€ æ¤œè¨¼</button>
            <button class="button" onclick="testCircularDetection()">å¾ªç’°å‚ç…§æ¤œå‡º</button>
            <button class="button success" onclick="clearAllPlugins()">å…¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å‰Šé™¤</button>
            <div id="validationResults" class="result-box">çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        import { voidCore } from './src/pure_plugin_system.js';

        // ãƒ­ã‚°è¦ç´ ã®è¨­å®š
        voidCore.setLogElement(document.getElementById('log'));
        
        // ãƒ†ã‚¹ãƒˆç”¨å¤‰æ•°
        let testPlugins = [];
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
        window.voidCore = voidCore;
        window.testBasicPluginCreation = testBasicPluginCreation;
        window.testHierarchicalCreation = testHierarchicalCreation;
        window.testDisplayNamePlugins = testDisplayNamePlugins;
        window.testSimpleReparenting = testSimpleReparenting;
        window.testRootToChild = testRootToChild;
        window.testCircularPrevention = testCircularPrevention;
        window.testGetChildren = testGetChildren;
        window.testGetDescendants = testGetDescendants;
        window.testGetAncestors = testGetAncestors;
        window.testGetPluginTree = testGetPluginTree;
        window.testHierarchyValidation = testHierarchyValidation;
        window.testCircularDetection = testCircularDetection;
        window.clearAllPlugins = clearAllPlugins;
        
        // ğŸš€ åŸºæœ¬ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆãƒ†ã‚¹ãƒˆ
        async function testBasicPluginCreation() {
            voidCore.log('ğŸ§ª Test: Basic Plugin Creation');
            
            const types = ['test.root1', 'test.root2', 'test.root3'];
            
            for (const type of types) {
                await createTestPlugin(type, null);
                await sleep(200);
            }
            
            const stats = voidCore.getSystemStats();
            document.getElementById('creationResults').innerHTML = 
                `âœ… ä½œæˆå®Œäº†: ${stats.pluginCount}å€‹ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€${stats.hierarchyStats.rootPlugins}å€‹ã®ãƒ«ãƒ¼ãƒˆ`;
        }
        
        // ğŸ—ï¸ éšå±¤ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆãƒ†ã‚¹ãƒˆ
        async function testHierarchicalCreation() {
            voidCore.log('ğŸ§ª Test: Hierarchical Plugin Creation');
            
            // ãƒ«ãƒ¼ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ
            const rootId = await createTestPlugin('test.parent', null);
            await sleep(300);
            
            // å­ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ
            const child1Id = await createTestPlugin('test.child1', rootId);
            const child2Id = await createTestPlugin('test.child2', rootId);
            await sleep(300);
            
            // å­«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ
            await createTestPlugin('test.grandchild1', child1Id);
            await createTestPlugin('test.grandchild2', child1Id);
            
            const stats = voidCore.getSystemStats();
            document.getElementById('creationResults').innerHTML = 
                `âœ… éšå±¤ä½œæˆå®Œäº†: æœ€å¤§ãƒ¬ãƒ™ãƒ«${stats.hierarchyStats.maxHierarchyLevel}`;
        }
        
        // ğŸ·ï¸ displayNameä»˜ããƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆãƒ†ã‚¹ãƒˆ
        async function testDisplayNamePlugins() {
            voidCore.log('ğŸ§ª Test: DisplayName Plugin Creation');
            
            await createTestPlugin('test.named', null, 'ãƒœã‚¹æˆ¦é—˜AI');
            await createTestPlugin('test.named', null, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ã‚¢');
            await createTestPlugin('test.named', null, 'ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ');
            
            document.getElementById('creationResults').innerHTML = 
                `âœ… displayNameä»˜ããƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆå®Œäº†`;
        }
        
        // ğŸ˜ï¸ å˜ç´”ãªè¦ªå­ç§»å‹•ãƒ†ã‚¹ãƒˆ
        async function testSimpleReparenting() {
            voidCore.log('ğŸ§ª Test: Simple Reparenting');
            
            // ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆ
            const parentA = await createTestPlugin('test.parentA', null);
            const parentB = await createTestPlugin('test.parentB', null);
            const child = await createTestPlugin('test.movingChild', parentA);
            
            await sleep(500);
            
            // è¦ªã‚’å¤‰æ›´
            await reparentPlugin(child, parentB);
            
            await sleep(500);
            
            const childPlugin = voidCore.getPlugin(child);
            const success = childPlugin && childPlugin.parentId === parentB;
            
            document.getElementById('reparentResults').innerHTML = 
                success ? `âœ… æˆ¸ç±ç•°å‹•æˆåŠŸ: ${child} â†’ ${parentB}` : `âŒ æˆ¸ç±ç•°å‹•å¤±æ•—`;
        }
        
        // ğŸ˜ï¸ ãƒ«ãƒ¼ãƒˆâ†’å­ã¸ã®ç§»å‹•ãƒ†ã‚¹ãƒˆ
        async function testRootToChild() {
            voidCore.log('ğŸ§ª Test: Root to Child Reparenting');
            
            const root = await createTestPlugin('test.rootToChild', null);
            const newParent = await createTestPlugin('test.newParent', null);
            
            await sleep(500);
            
            // ãƒ«ãƒ¼ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å­ã«å¤‰æ›´
            await reparentPlugin(root, newParent);
            
            const plugin = voidCore.getPlugin(root);
            const success = plugin && plugin.parentId === newParent;
            
            document.getElementById('reparentResults').innerHTML = 
                success ? `âœ… ãƒ«ãƒ¼ãƒˆâ†’å­ç§»å‹•æˆåŠŸ` : `âŒ ãƒ«ãƒ¼ãƒˆâ†’å­ç§»å‹•å¤±æ•—`;
        }
        
        // ğŸ”„ å¾ªç’°å‚ç…§é˜²æ­¢ãƒ†ã‚¹ãƒˆ
        async function testCircularPrevention() {
            voidCore.log('ğŸ§ª Test: Circular Reference Prevention');
            
            const parent = await createTestPlugin('test.circularParent', null);
            const child = await createTestPlugin('test.circularChild', parent);
            
            await sleep(500);
            
            // å¾ªç’°å‚ç…§ã‚’ä½œã‚ã†ã¨ã™ã‚‹ï¼ˆparent ã‚’ child ã®å­ã«ã™ã‚‹ï¼‰
            await reparentPlugin(parent, child);
            
            const parentPlugin = voidCore.getPlugin(parent);
            const preventedCircular = parentPlugin.parentId !== child;
            
            document.getElementById('reparentResults').innerHTML = 
                preventedCircular ? `âœ… å¾ªç’°å‚ç…§é˜²æ­¢æˆåŠŸ` : `âŒ å¾ªç’°å‚ç…§é˜²æ­¢å¤±æ•—`;
        }
        
        // ğŸ—ï¸ getChildren()ãƒ†ã‚¹ãƒˆ
        async function testGetChildren() {
            voidCore.log('ğŸ§ª Test: getChildren() API');
            
            const parent = await createTestPlugin('test.parentForChildren', null);
            await createTestPlugin('test.child1', parent);
            await createTestPlugin('test.child2', parent);
            await createTestPlugin('test.child3', parent);
            
            const children = voidCore.getChildren(parent);
            document.getElementById('apiResults').innerHTML = 
                `âœ… getChildren(): ${children.length}å€‹ã®å­ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™ºè¦‹`;
        }
        
        // ğŸ—ï¸ getDescendants()ãƒ†ã‚¹ãƒˆ
        async function testGetDescendants() {
            voidCore.log('ğŸ§ª Test: getDescendants() API');
            
            const root = await createTestPlugin('test.rootForDescendants', null);
            const child = await createTestPlugin('test.child', root);
            await createTestPlugin('test.grandchild1', child);
            await createTestPlugin('test.grandchild2', child);
            
            const descendants = voidCore.getDescendants(root);
            document.getElementById('apiResults').innerHTML = 
                `âœ… getDescendants(): ${descendants.length}å€‹ã®å­å­«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™ºè¦‹`;
        }
        
        // ğŸ—ï¸ getAncestors()ãƒ†ã‚¹ãƒˆ
        async function testGetAncestors() {
            voidCore.log('ğŸ§ª Test: getAncestors() API');
            
            const root = await createTestPlugin('test.rootForAncestors', null);
            const child = await createTestPlugin('test.child', root);
            const grandchild = await createTestPlugin('test.grandchild', child);
            
            const ancestors = voidCore.getAncestors(grandchild);
            document.getElementById('apiResults').innerHTML = 
                `âœ… getAncestors(): ${ancestors.length}å€‹ã®ç¥–å…ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™ºè¦‹`;
        }
        
        // ğŸ—ï¸ getPluginTree()ãƒ†ã‚¹ãƒˆ
        async function testGetPluginTree() {
            voidCore.log('ğŸ§ª Test: getPluginTree() API');
            
            const tree = voidCore.getPluginTree();
            const totalNodes = countTreeNodes(tree);
            
            document.getElementById('apiResults').innerHTML = 
                `âœ… getPluginTree(): ${tree.length}å€‹ã®ãƒ«ãƒ¼ãƒˆã€åˆè¨ˆ${totalNodes}ãƒãƒ¼ãƒ‰`;
        }
        
        // ğŸ” éšå±¤æ§‹é€ æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
        async function testHierarchyValidation() {
            voidCore.log('ğŸ§ª Test: Hierarchy Validation');
            
            const validation = voidCore.validateHierarchyIntegrity();
            
            document.getElementById('validationResults').innerHTML = 
                validation.isValid ? 
                `âœ… éšå±¤æ§‹é€ æ•´åˆæ€§OK` : 
                `âŒ éšå±¤æ§‹é€ ã«${validation.issues.length}å€‹ã®å•é¡Œ`;
        }
        
        // ğŸ”„ å¾ªç’°å‚ç…§æ¤œå‡ºãƒ†ã‚¹ãƒˆ
        async function testCircularDetection() {
            voidCore.log('ğŸ§ª Test: Circular Detection');
            
            const pluginA = await createTestPlugin('test.circularA', null);
            const pluginB = await createTestPlugin('test.circularB', pluginA);
            
            const wouldBeCircular = voidCore._wouldCreateCircularReference(pluginA, pluginB);
            
            document.getElementById('validationResults').innerHTML = 
                wouldBeCircular ? 
                `âœ… å¾ªç’°å‚ç…§æ­£ã—ãæ¤œå‡º` : 
                `âŒ å¾ªç’°å‚ç…§æ¤œå‡ºå¤±æ•—`;
        }
        
        // ğŸ—‘ï¸ å…¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å‰Šé™¤
        async function clearAllPlugins() {
            voidCore.log('ğŸ§ª Clear: All Plugins');
            
            const plugins = voidCore.getAllPlugins();
            for (const plugin of plugins) {
                await destroyTestPlugin(plugin.pluginId);
                await sleep(100);
            }
            
            document.getElementById('validationResults').innerHTML = 
                `ğŸ—‘ï¸ å…¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å‰Šé™¤å®Œäº†`;
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function createTestPlugin(type, parentId, displayName = null) {
            const correlationId = `test-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
            
            const payload = {
                type,
                displayName,
                config: { testMode: true },
                parent: parentId,
                correlationId,
                maxDepth: 10,
                resourceCost: 1
            };
            
            await voidCore.publish({
                type: 'IntentRequest',
                action: 'system.createPlugin',
                payload,
                timestamp: Date.now()
            });
            
            // çŸ­æ™‚é–“å¾…æ©Ÿã—ã¦IDã‚’å–å¾—
            await sleep(100);
            const plugins = voidCore.getAllPlugins();
            const newPlugin = plugins.find(p => p.metadata?.correlationId === correlationId);
            return newPlugin ? newPlugin.pluginId : null;
        }
        
        async function reparentPlugin(pluginId, newParentId) {
            const correlationId = `reparent-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
            
            await voidCore.publish({
                type: 'IntentRequest',
                action: 'system.reparentPlugin',
                payload: {
                    pluginId,
                    newParentId,
                    correlationId
                },
                timestamp: Date.now()
            });
        }
        
        async function destroyTestPlugin(pluginId) {
            const correlationId = `destroy-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
            
            await voidCore.publish({
                type: 'IntentRequest',
                action: 'system.destroyPlugin',
                payload: {
                    pluginId,
                    correlationId
                },
                timestamp: Date.now()
            });
        }
        
        function countTreeNodes(tree) {
            let count = 0;
            tree.forEach(node => {
                count += 1 + (node.children ? countTreeNodes(node.children) : 0);
            });
            return count;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // åˆæœŸåŒ–
        voidCore.log('ğŸ§ª Phase 5.2 Complete Test Suite Initialized');
        voidCore.log('ğŸ¯ å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¢ãŒæº–å‚™ã§ãã¾ã—ãŸ');
    </script>
</body>
</html>