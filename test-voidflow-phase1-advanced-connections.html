<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ€ VoidFlow Phase 1 - é«˜åº¦æ¥ç¶šGUI ãƒ†ã‚¹ãƒˆ</title>
    
    <!-- VoidFlow CSS -->
    <link rel="stylesheet" href="voidflow/css/base.css">
    <link rel="stylesheet" href="voidflow/css/layout.css">
    <link rel="stylesheet" href="voidflow/css/nodes.css">
    <link rel="stylesheet" href="voidflow/css/canvas.css">
    
    <style>
        /* ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .test-controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .test-button:hover {
            background: #357abd;
            transform: translateY(-1px);
        }
        
        .test-button.fan-out { background: #00ff88; color: #000; }
        .test-button.fan-out:hover { background: #00cc6a; }
        
        .test-button.bundle { background: #ff6b35; }
        .test-button.bundle:hover { background: #e55a2b; }
        
        .test-button.delete { background: #e91e63; }
        .test-button.delete:hover { background: #c2185b; }
        
        .stats-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #4a90e2;
            border-radius: 4px;
            padding: 10px;
            color: #fff;
            font-size: 12px;
            min-width: 200px;
        }
        
        .stat-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            color: #00ff88;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="voidflow-container">
        <header class="header">
            <h1>ğŸŒ€ VoidFlow Phase 1 - é«˜åº¦æ¥ç¶šGUI ãƒ†ã‚¹ãƒˆ</h1>
        </header>
        
        <!-- ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="test-controls">
            <button class="test-button" onclick="createTestNodes()">ğŸ¨ ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒ‰ä½œæˆ</button>
            <button class="test-button fan-out" onclick="testFanOutConnections()">ğŸŒ€ æ‰‡å½¢åˆ†æ•£ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button bundle" onclick="testBundleConnections()">ğŸ“¦ æŸã­ç·šãƒ†ã‚¹ãƒˆï¼ˆäºˆå®šï¼‰</button>
            <button class="test-button delete" onclick="testDeleteUI()">ğŸ—‘ï¸ å‰Šé™¤UIãƒ†ã‚¹ãƒˆï¼ˆäºˆå®šï¼‰</button>
            <button class="test-button" onclick="testAnimations()">âœ¨ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="clearAll()">ğŸ§¹ å…¨ã‚¯ãƒªã‚¢</button>
        </div>
        
        <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
        <div class="canvas-area" style="position: relative; width: 100%; height: 600px;">
            <div class="canvas-grid"></div>
            <div class="zen-message" id="zenMessage">
                <div class="zen-title">ğŸŒ€ é«˜åº¦æ¥ç¶šGUI ãƒ†ã‚¹ãƒˆç’°å¢ƒ</div>
                <div class="zen-subtitle">æ‰‡å½¢åˆ†æ•£ãƒ»æŸã­ç·šãƒ»å‰Šé™¤é¸æŠæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ</div>
            </div>
            <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
            </svg>
        </div>
        
        <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
        <div class="stats-panel">
            <h3 style="margin: 0 0 10px 0; color: #4a90e2;">ğŸ“Š æ¥ç¶šçµ±è¨ˆ</h3>
            <div class="stat-item">
                <span>ãƒãƒ¼ãƒ‰æ•°:</span>
                <span class="stat-value" id="nodeCount">0</span>
            </div>
            <div class="stat-item">
                <span>æ¥ç¶šæ•°:</span>
                <span class="stat-value" id="connectionCount">0</span>
            </div>
            <div class="stat-item">
                <span>æ‰‡å½¢è¡¨ç¤º:</span>
                <span class="stat-value" id="fanOutCount">0</span>
            </div>
            <div class="stat-item">
                <span>FPS:</span>
                <span class="stat-value" id="fps">60</span>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { VoidCoreConnectionManager } from './voidflow/js/voidcore-connection-manager.js'
        import { VoidCoreUI } from './voidflow/js/voidcore-ui.js'
        
        let connectionManager = null
        let voidCoreUI = null
        let nodeIdCounter = 0
        let nodes = new Map()
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
        window.createTestNodes = createTestNodes
        window.testFanOutConnections = testFanOutConnections
        window.testBundleConnections = testBundleConnections
        window.testDeleteUI = testDeleteUI
        window.testAnimations = testAnimations
        window.clearAll = clearAll
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸŒ€ Phase 1 é«˜åº¦æ¥ç¶šGUI ãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                // VoidCoreUIåˆæœŸåŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                voidCoreUI = {
                    log: (msg) => console.log(`[VoidCoreUI] ${msg}`)
                }
                
                // ConnectionManageråˆæœŸåŒ–
                connectionManager = new VoidCoreConnectionManager()
                await connectionManager.onActivated()
                
                console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†')
                
                // Zenãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                setTimeout(() => {
                    document.getElementById('zenMessage').style.display = 'none'
                }, 2000)
                
                // FPSè¨ˆæ¸¬é–‹å§‹
                startFPSMonitor()
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error)
            }
        })
        
        // ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒ‰ä½œæˆ
        function createTestNodes() {
            const canvas = document.querySelector('.canvas-area')
            const nodeTypes = [
                'button.send',
                'input.text',
                'string.uppercase',
                'output.console',
                'web.fetch'
            ]
            
            // 5ã¤ã®ãƒãƒ¼ãƒ‰ã‚’å††å½¢ã«é…ç½®
            const centerX = 400
            const centerY = 300
            const radius = 150
            
            nodeTypes.forEach((type, index) => {
                const angle = (index / nodeTypes.length) * Math.PI * 2
                const x = centerX + Math.cos(angle) * radius
                const y = centerY + Math.sin(angle) * radius
                
                createNode(type, x, y)
            })
            
            updateStats()
        }
        
        // ãƒãƒ¼ãƒ‰ä½œæˆ
        function createNode(nodeType, x, y) {
            const nodeId = `test-node-${nodeIdCounter++}`
            const element = document.createElement('div')
            element.className = 'voidcore-ui-element'
            element.id = `ui-element-${nodeId}`
            element.dataset.pluginId = nodeId
            element.dataset.nodeType = nodeType
            element.style.position = 'absolute'
            element.style.left = x + 'px'
            element.style.top = y + 'px'
            element.innerHTML = `
                <div class="node-header">${getNodeDisplayName(nodeType)}</div>
                <div class="node-content">Test Node ${nodeIdCounter}</div>
            `
            
            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            makeDraggable(element)
            
            document.querySelector('.canvas-area').appendChild(element)
            nodes.set(nodeId, { element, type: nodeType, x, y })
            
            return nodeId
        }
        
        // æ‰‡å½¢åˆ†æ•£ãƒ†ã‚¹ãƒˆ
        function testFanOutConnections() {
            if (nodes.size < 2) {
                alert('å…ˆã«ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„')
                return
            }
            
            const nodeArray = Array.from(nodes.keys())
            const sourceId = nodeArray[0]
            
            // 1ã¤ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ä»–ã®å…¨ãƒãƒ¼ãƒ‰ã¸æ¥ç¶š
            for (let i = 1; i < nodeArray.length; i++) {
                try {
                    const connectionId = connectionManager.createConnection(
                        sourceId,
                        nodeArray[i],
                        'data-flow'
                    )
                    console.log(`âœ… æ¥ç¶šä½œæˆ: ${sourceId} â†’ ${nodeArray[i]}`)
                } catch (error) {
                    console.error(`âŒ æ¥ç¶šå¤±æ•—:`, error)
                }
            }
            
            updateStats()
        }
        
        // æŸã­ç·šãƒ†ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰
        function testBundleConnections() {
            alert('ğŸ“¦ æŸã­ç·šæ©Ÿèƒ½ã¯æ¬¡ã®å®Ÿè£…äºˆå®šã§ã™')
        }
        
        // å‰Šé™¤UIãƒ†ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰
        function testDeleteUI() {
            alert('ğŸ—‘ï¸ å‰Šé™¤é¸æŠUIæ©Ÿèƒ½ã¯æ¬¡ã®å®Ÿè£…äºˆå®šã§ã™')
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
        function testAnimations() {
            // å…¨æ¥ç¶šç·šã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            connectionManager.connections.forEach((conn, id) => {
                connectionManager.animateConnection(id)
            })
        }
        
        // å…¨ã‚¯ãƒªã‚¢
        function clearAll() {
            // å…¨æ¥ç¶šå‰Šé™¤
            const connectionIds = Array.from(connectionManager.connections.keys())
            connectionIds.forEach(id => {
                connectionManager.removeConnection(id)
            })
            
            // å…¨ãƒãƒ¼ãƒ‰å‰Šé™¤
            nodes.forEach((node, id) => {
                node.element.remove()
            })
            nodes.clear()
            nodeIdCounter = 0
            
            updateStats()
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            document.getElementById('nodeCount').textContent = nodes.size
            document.getElementById('connectionCount').textContent = connectionManager.connections.size
            
            // æ‰‡å½¢è¡¨ç¤ºã‚«ã‚¦ãƒ³ãƒˆ
            let fanOutCount = 0
            const sourceCounts = new Map()
            connectionManager.connections.forEach(conn => {
                const count = (sourceCounts.get(conn.sourcePluginId) || 0) + 1
                sourceCounts.set(conn.sourcePluginId, count)
            })
            sourceCounts.forEach(count => {
                if (count > 2) fanOutCount++
            })
            document.getElementById('fanOutCount').textContent = fanOutCount
        }
        
        // FPSç›£è¦–
        function startFPSMonitor() {
            let lastTime = performance.now()
            let frames = 0
            
            function updateFPS() {
                frames++
                const currentTime = performance.now()
                if (currentTime >= lastTime + 1000) {
                    const fps = Math.round((frames * 1000) / (currentTime - lastTime))
                    document.getElementById('fps').textContent = fps
                    frames = 0
                    lastTime = currentTime
                }
                requestAnimationFrame(updateFPS)
            }
            
            requestAnimationFrame(updateFPS)
        }
        
        // ãƒãƒ¼ãƒ‰è¡¨ç¤ºåå–å¾—
        function getNodeDisplayName(nodeType) {
            const names = {
                'button.send': 'ğŸ“¤ Send',
                'input.text': 'ğŸ“ Text',
                'string.uppercase': 'ğŸ”¤ Upper',
                'output.console': 'ğŸ–¥ï¸ Console',
                'web.fetch': 'ğŸŒ Fetch'
            }
            return names[nodeType] || nodeType
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        function makeDraggable(element) {
            let isDragging = false
            let startX, startY, initialX, initialY
            
            element.addEventListener('mousedown', (e) => {
                isDragging = true
                startX = e.clientX
                startY = e.clientY
                initialX = element.offsetLeft
                initialY = element.offsetTop
                element.style.zIndex = '1000'
                e.preventDefault()
            })
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return
                
                const dx = e.clientX - startX
                const dy = e.clientY - startY
                
                element.style.left = (initialX + dx) + 'px'
                element.style.top = (initialY + dy) + 'px'
                
                // æ¥ç¶šç·šã‚’å†æç”»
                connectionManager.updateAllConnectionLines()
            })
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false
                    element.style.zIndex = ''
                }
            })
        }
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§
        window.connectionManager = connectionManager
        window.nodes = nodes
    </script>
</body>
</html>