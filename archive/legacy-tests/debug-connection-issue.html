<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” æ¥ç¶šãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸</title>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
            margin: 20px;
        }
        .debug-panel {
            background: #2a2a2a;
            border: 1px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357abd; }
        #output {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” VoidFlowæ¥ç¶šãƒ‡ãƒãƒƒã‚°</h1>
    
    <div class="debug-panel">
        <h2>ğŸ§ª ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h2>
        <button onclick="checkConnectionManager()">ğŸ”— ConnectionManagerç¢ºèª</button>
        <button onclick="checkLineRenderer()">ğŸŒ€ LineRendererç¢ºèª</button>
        <button onclick="debugConnections()">ğŸ“Š æ¥ç¶šçŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°</button>
        <button onclick="testManualConnection()">ğŸ¯ æ‰‹å‹•æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearOutput()">ğŸ§¹ å‡ºåŠ›ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="debug-panel">
        <h2>ğŸ“¤ å‡ºåŠ›</h2>
        <div id="output"></div>
    </div>
    
    <script>
        let output = document.getElementById('output')
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString()
            output.innerHTML += `[${timestamp}] ${message}<br>`
            output.scrollTop = output.scrollHeight
        }
        
        function checkConnectionManager() {
            log('ğŸ” ConnectionManagerç¢ºèªé–‹å§‹...')
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            if (typeof window.connectionManager !== 'undefined') {
                log('âœ… window.connectionManager å­˜åœ¨')
                log(`   - connections: ${window.connectionManager.connections.size}å€‹`)
                log(`   - lineRenderer: ${window.connectionManager.lineRenderer ? 'å­˜åœ¨' : 'æœªåˆæœŸåŒ–'}`)
            } else {
                log('âŒ window.connectionManager ä¸å­˜åœ¨')
            }
            
            // VoidFlowãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
            try {
                const iframe = document.createElement('iframe')
                iframe.src = '/voidflow/index-voidcore.html'
                iframe.style.display = 'none'
                document.body.appendChild(iframe)
                
                iframe.onload = () => {
                    try {
                        const voidflowWindow = iframe.contentWindow
                        if (voidflowWindow.connectionManager) {
                            log('âœ… VoidFlowãƒšãƒ¼ã‚¸ã®connectionManagerç™ºè¦‹')
                            window.testConnectionManager = voidflowWindow.connectionManager
                        } else {
                            log('âŒ VoidFlowãƒšãƒ¼ã‚¸ã®connectionManageræœªåˆæœŸåŒ–')
                        }
                    } catch (e) {
                        log(`âŒ iframeã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`)
                    }
                    iframe.remove()
                }
            } catch (e) {
                log(`âŒ iframeä½œæˆã‚¨ãƒ©ãƒ¼: ${e.message}`)
            }
        }
        
        function checkLineRenderer() {
            log('ğŸŒ€ LineRendererç¢ºèªé–‹å§‹...')
            
            // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            import('/voidflow/js/connection-line-renderer.js')
                .then(module => {
                    log('âœ… ConnectionLineRenderer ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ')
                    log(`   - exports: ${Object.keys(module)}`)
                    
                    // ãƒ†ã‚¹ãƒˆç”¨SVGä½œæˆ
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
                    svg.style.width = '200px'
                    svg.style.height = '100px'
                    svg.style.border = '1px solid #4a90e2'
                    
                    const renderer = new module.ConnectionLineRenderer(svg)
                    log('âœ… ConnectionLineRenderer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ')
                    
                    // ãƒ†ã‚¹ãƒˆæç”»
                    renderer.renderConnection('test-1', {x: 10, y: 50}, {x: 190, y: 50}, {
                        color: '#00ff88',
                        width: 3
                    })
                    log('âœ… ãƒ†ã‚¹ãƒˆæ¥ç¶šç·šæç”»æˆåŠŸ')
                    
                    document.body.appendChild(svg)
                })
                .catch(error => {
                    log(`âŒ ConnectionLineRendererèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`)
                })
        }
        
        function debugConnections() {
            log('ğŸ“Š æ¥ç¶šçŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°é–‹å§‹...')
            
            if (window.testConnectionManager) {
                const cm = window.testConnectionManager
                log(`ğŸ”— æ¥ç¶šæ•°: ${cm.connections.size}`)
                log(`ğŸ”— ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ¥ç¶š: ${cm.pluginConnections.size}`)
                
                cm.connections.forEach((conn, id) => {
                    log(`   - ${id}: ${conn.sourcePluginId} â†’ ${conn.targetPluginId}`)
                })
                
                if (cm.lineRenderer) {
                    log(`ğŸŒ€ LineRendererçŠ¶æ…‹:`)
                    log(`   - ç®¡ç†ãƒ‘ã‚¹æ•°: ${cm.lineRenderer.connectionPaths.size}`)
                } else {
                    log('âŒ LineRendereræœªåˆæœŸåŒ–')
                }
            } else {
                log('âŒ ConnectionManageræœªå–å¾— - å…ˆã«ConnectionManagerç¢ºèªã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„')
            }
        }
        
        function testManualConnection() {
            log('ğŸ¯ æ‰‹å‹•æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            if (window.testConnectionManager) {
                try {
                    const cm = window.testConnectionManager
                    
                    // ãƒ†ã‚¹ãƒˆæ¥ç¶šä½œæˆ
                    const connId = cm.createConnection('test-source', 'test-target-1', 'test-flow')
                    log(`âœ… æ¥ç¶š1ä½œæˆ: ${connId}`)
                    
                    const connId2 = cm.createConnection('test-source', 'test-target-2', 'test-flow')
                    log(`âœ… æ¥ç¶š2ä½œæˆ: ${connId2}`)
                    
                    const connId3 = cm.createConnection('test-source', 'test-target-3', 'test-flow')
                    log(`âœ… æ¥ç¶š3ä½œæˆ: ${connId3}`)
                    
                    log('ğŸ“Š æ¥ç¶šå¾Œã®çŠ¶æ…‹:')
                    debugConnections()
                    
                } catch (error) {
                    log(`âŒ æ‰‹å‹•æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                }
            } else {
                log('âŒ ConnectionManageræœªå–å¾—')
            }
        }
        
        function clearOutput() {
            output.innerHTML = ''
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            log('ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†')
            checkConnectionManager()
        })
    </script>
</body>
</html>