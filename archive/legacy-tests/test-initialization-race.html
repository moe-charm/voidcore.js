<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” åˆæœŸåŒ–ç«¶åˆçŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°å°‚ç”¨ãƒ‡ãƒ¢</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      background: #2d2d2d;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #444;
    }
    h1 {
      color: #4CAF50;
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      color: #2196F3;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 5px;
    }
    .test-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      margin: 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
    }
    .test-button:hover {
      background: #45a049;
    }
    .danger-button {
      background: #f44336;
    }
    .danger-button:hover {
      background: #da190b;
    }
    .log-output {
      background: #000;
      color: #0f0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .stats {
      background: #333;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
    .stat-item {
      background: #444;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 12px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” åˆæœŸåŒ–ç«¶åˆçŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°å°‚ç”¨ãƒ‡ãƒ¢</h1>
    
    <div class="section">
      <h2>ğŸ¯ ãƒ†ã‚¹ãƒˆç›®çš„</h2>
      <p>VoidCore ã¨ ChannelManager ã®åˆæœŸåŒ–ç«¶åˆçŠ¶æ…‹ã‚’å†ç¾ãƒ»æ¤œè¨¼ã—ã¾ã™</p>
      <ul>
        <li>è¤‡æ•°ã®subscribe()åŒæ™‚å‘¼ã³å‡ºã—ã§ã®åˆæœŸåŒ–ç«¶åˆ</li>
        <li>VoidCore._ensureInitialized() ã®ç«¶åˆ</li>
        <li>ChannelManager.initialize() ã®ç«¶åˆ</li>
        <li>Promise-based initialization pattern ã®æ¤œè¨¼</li>
      </ul>
    </div>

    <div class="section">
      <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
      <button class="test-button" onclick="testSingleSubscribe()">
        ğŸ”” å˜ä¸€Subscribe ãƒ†ã‚¹ãƒˆ
      </button>
      <button class="test-button" onclick="testMultipleSubscribe()">
        ğŸ””ğŸ”” è¤‡æ•°Subscribe ãƒ†ã‚¹ãƒˆ (ç«¶åˆå†ç¾)
      </button>
      <button class="test-button" onclick="testRapidSubscribe()">
        âš¡ é«˜é€ŸSubscribe ãƒ†ã‚¹ãƒˆ (æ¥µç«¯ãªç«¶åˆ)
      </button>
      <button class="test-button danger-button" onclick="testConcurrentPublish()">
        ğŸ“¨ åŒæ™‚Publish ãƒ†ã‚¹ãƒˆ (æœ€æ‚ªã‚±ãƒ¼ã‚¹)
      </button>
      <button class="test-button" onclick="clearLog()">
        ğŸ§¹ ãƒ­ã‚°ã‚¯ãƒªã‚¢
      </button>
    </div>

    <div class="section">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
      <div class="stats" id="stats">
        <div class="stat-item">
          <div class="stat-value" id="voidcore-init-count">0</div>
          <div class="stat-label">VoidCoreåˆæœŸåŒ–å›æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="channelmanager-init-count">0</div>
          <div class="stat-label">ChannelManageråˆæœŸåŒ–å›æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="transport-init-count">0</div>
          <div class="stat-label">TransportåˆæœŸåŒ–å›æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="subscribe-count">0</div>
          <div class="stat-label">Subscribeå‘¼ã³å‡ºã—å›æ•°</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
      <div class="log-output" id="debug-log"></div>
    </div>

    <div class="section">
      <h2>ğŸ”§ VoidCore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çŠ¶æ…‹</h2>
      <div class="log-output" id="voidcore-state"></div>
    </div>
  </div>

  <script type="module">
    // VoidCoreã‚¯ãƒ©ã‚¹ã‚’ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { ChannelManager } from './src/channel-manager.js'
    
    // VoidCoreã‚¯ãƒ©ã‚¹ã‚’å†å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    class VoidCore {
      constructor(transport = null) {
        this.channelManager = new ChannelManager(transport)
        this.initialized = false
        this.subscribers = new Map()
        this.logElement = null
        this.initPromise = null
        this.coreId = `core-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
        this.plugins = []
      }
      
      setLogElement(element) {
        this.logElement = element
        this.channelManager.setLogElement(element)
      }
      
      async _ensureInitialized() {
        if (!this.initialized && !this.initPromise) {
          this.initPromise = this.channelManager.initialize().then(() => {
            this.initialized = true
          })
        }
        
        if (this.initPromise) {
          await this.initPromise
        }
      }
      
      subscribe(type, handler) {
        if (!this.initialized && !this.initPromise) {
          this._ensureInitialized().catch(console.error)
        }
        
        const unsubscribe = this.channelManager.subscribe(type, handler)
        
        if (!this.subscribers.has(type)) {
          this.subscribers.set(type, new Set())
        }
        this.subscribers.get(type).add(handler)
        
        return unsubscribe
      }
      
      async publish(message) {
        if (!message || !message.type) {
          return 0
        }
        
        await this._ensureInitialized()
        const deliveredCount = await this.channelManager.publish(message)
        return deliveredCount
      }
      
      log(msg) {
        if (this.logElement) {
          this.logElement.innerHTML += msg + "<br>"
          setTimeout(() => {
            this.logElement.scrollTop = this.logElement.scrollHeight
          }, 0)
        } else {
          console.log(msg)
        }
      }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    let debugCounters = {
      voidcoreInit: 0,
      channelManagerInit: 0,
      transportInit: 0,
      subscribeCount: 0
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
    const debugLog = document.getElementById('debug-log')
    const voidcoreState = document.getElementById('voidcore-state')
    
    function log(message) {
      const timestamp = new Date().toISOString().substr(11, 12)
      debugLog.innerHTML += `[${timestamp}] ${message}\n`
      debugLog.scrollTop = debugLog.scrollHeight
      console.log(message)
    }

    function updateStats() {
      document.getElementById('voidcore-init-count').textContent = debugCounters.voidcoreInit
      document.getElementById('channelmanager-init-count').textContent = debugCounters.channelManagerInit
      document.getElementById('transport-init-count').textContent = debugCounters.transportInit
      document.getElementById('subscribe-count').textContent = debugCounters.subscribeCount
    }

    function updateVoidCoreState() {
      const state = `
VoidCoreçŠ¶æ…‹:
  initialized: ${window.testVoidCore?.initialized || 'N/A'}
  initPromise: ${window.testVoidCore?.initPromise ? 'EXISTS' : 'NULL'}
  coreId: ${window.testVoidCore?.coreId || 'N/A'}
  
ChannelManagerçŠ¶æ…‹:
  initialized: ${window.testVoidCore?.channelManager?.initialized || 'N/A'}
  _initializing: ${window.testVoidCore?.channelManager?._initializing || 'N/A'}
  
TransportçŠ¶æ…‹:
  initialized: ${window.testVoidCore?.channelManager?.transport?.initialized || 'N/A'}
  type: ${window.testVoidCore?.channelManager?.transport?.constructor?.name || 'N/A'}
      `
      voidcoreState.textContent = state
    }

    // åˆæœŸåŒ–ã‚«ã‚¦ãƒ³ãƒˆç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    function createDebugVoidCore() {
      const voidCore = new VoidCore()
      
      // VoidCore._ensureInitialized ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
      const originalEnsureInitialized = voidCore._ensureInitialized.bind(voidCore)
      voidCore._ensureInitialized = async function() {
        debugCounters.voidcoreInit++
        log(`ğŸ” VoidCore._ensureInitialized() å‘¼ã³å‡ºã— #${debugCounters.voidcoreInit}`)
        updateStats()
        return await originalEnsureInitialized()
      }
      
      // ChannelManager.initialize ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
      const originalChannelManagerInit = voidCore.channelManager.initialize.bind(voidCore.channelManager)
      voidCore.channelManager.initialize = async function() {
        debugCounters.channelManagerInit++
        log(`ğŸ” ChannelManager.initialize() å‘¼ã³å‡ºã— #${debugCounters.channelManagerInit}`)
        updateStats()
        return await originalChannelManagerInit()
      }
      
      // Transport.initialize ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
      const originalTransportInit = voidCore.channelManager.transport.initialize.bind(voidCore.channelManager.transport)
      voidCore.channelManager.transport.initialize = async function() {
        debugCounters.transportInit++
        log(`ğŸ” Transport.initialize() å‘¼ã³å‡ºã— #${debugCounters.transportInit}`)
        updateStats()
        return await originalTransportInit()
      }
      
      // Subscribe ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
      const originalSubscribe = voidCore.subscribe.bind(voidCore)
      voidCore.subscribe = function(type, handler) {
        debugCounters.subscribeCount++
        log(`ğŸ” voidCore.subscribe(${type}) å‘¼ã³å‡ºã— #${debugCounters.subscribeCount}`)
        updateStats()
        return originalSubscribe(type, handler)
      }
      
      return voidCore
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚¹ãƒˆé–¢æ•°
    window.testSingleSubscribe = async function() {
      log('ğŸ”” === å˜ä¸€Subscribe ãƒ†ã‚¹ãƒˆé–‹å§‹ ===')
      
      const voidCore = createDebugVoidCore()
      window.testVoidCore = voidCore
      
      voidCore.subscribe('TestMessage', (message) => {
        log(`ğŸ“¨ TestMessageå—ä¿¡: ${JSON.stringify(message)}`)
      })
      
      // çŠ¶æ…‹ç¢ºèª
      setTimeout(() => {
        updateVoidCoreState()
        log('ğŸ”” === å˜ä¸€Subscribe ãƒ†ã‚¹ãƒˆå®Œäº† ===')
      }, 100)
    }

    window.testMultipleSubscribe = async function() {
      log('ğŸ””ğŸ”” === è¤‡æ•°Subscribe ãƒ†ã‚¹ãƒˆé–‹å§‹ ===')
      
      const voidCore = createDebugVoidCore()
      window.testVoidCore = voidCore
      
      // è¤‡æ•°ã®subscribeã‚’åŒæ™‚ã«å®Ÿè¡Œ
      const promises = []
      for (let i = 0; i < 5; i++) {
        promises.push(new Promise(resolve => {
          voidCore.subscribe(`TestMessage${i}`, (message) => {
            log(`ğŸ“¨ TestMessage${i}å—ä¿¡: ${JSON.stringify(message)}`)
          })
          resolve()
        }))
      }
      
      await Promise.all(promises)
      
      // çŠ¶æ…‹ç¢ºèª
      setTimeout(() => {
        updateVoidCoreState()
        log('ğŸ””ğŸ”” === è¤‡æ•°Subscribe ãƒ†ã‚¹ãƒˆå®Œäº† ===')
      }, 100)
    }

    window.testRapidSubscribe = async function() {
      log('âš¡ === é«˜é€ŸSubscribe ãƒ†ã‚¹ãƒˆé–‹å§‹ ===')
      
      const voidCore = createDebugVoidCore()
      window.testVoidCore = voidCore
      
      // æ¥µç«¯ã«é«˜é€Ÿãªsubscribeã‚’å®Ÿè¡Œ
      const promises = []
      for (let i = 0; i < 20; i++) {
        promises.push(new Promise(resolve => {
          setTimeout(() => {
            voidCore.subscribe(`RapidTest${i}`, (message) => {
              log(`ğŸ“¨ RapidTest${i}å—ä¿¡: ${JSON.stringify(message)}`)
            })
            resolve()
          }, Math.random() * 10) // 0-10ms ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
        }))
      }
      
      await Promise.all(promises)
      
      // çŠ¶æ…‹ç¢ºèª
      setTimeout(() => {
        updateVoidCoreState()
        log('âš¡ === é«˜é€ŸSubscribe ãƒ†ã‚¹ãƒˆå®Œäº† ===')
      }, 200)
    }

    window.testConcurrentPublish = async function() {
      log('ğŸ“¨ === åŒæ™‚Publish ãƒ†ã‚¹ãƒˆé–‹å§‹ ===')
      
      const voidCore = createDebugVoidCore()
      window.testVoidCore = voidCore
      
      // Subscribe + Publish ã‚’åŒæ™‚ã«å®Ÿè¡Œ
      const promises = []
      
      // Subscribeç¾¤
      for (let i = 0; i < 10; i++) {
        promises.push(new Promise(resolve => {
          voidCore.subscribe(`ConcurrentTest${i}`, (message) => {
            log(`ğŸ“¨ ConcurrentTest${i}å—ä¿¡: ${JSON.stringify(message)}`)
          })
          resolve()
        }))
      }
      
      // Publishç¾¤
      for (let i = 0; i < 5; i++) {
        promises.push(new Promise(resolve => {
          setTimeout(async () => {
            await voidCore.publish({
              type: `ConcurrentTest${i}`,
              payload: { test: `concurrent-${i}` }
            })
            resolve()
          }, Math.random() * 50) // 0-50ms ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
        }))
      }
      
      await Promise.all(promises)
      
      // çŠ¶æ…‹ç¢ºèª
      setTimeout(() => {
        updateVoidCoreState()
        log('ğŸ“¨ === åŒæ™‚Publish ãƒ†ã‚¹ãƒˆå®Œäº† ===')
      }, 200)
    }

    window.clearLog = function() {
      debugLog.innerHTML = ''
      debugCounters = {
        voidcoreInit: 0,
        channelManagerInit: 0,
        transportInit: 0,
        subscribeCount: 0
      }
      updateStats()
      log('ğŸ§¹ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†')
    }

    // åˆæœŸåŒ–
    log('ğŸ” åˆæœŸåŒ–ç«¶åˆçŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°å°‚ç”¨ãƒ‡ãƒ¢é–‹å§‹')
    updateStats()
    updateVoidCoreState()
  </script>
</body>
</html>