<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª VoidFlow Phase 3 - æ¥ç¶šç®¡ç†IntentåŒ–ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            background: #1a1a1a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            margin: 20px;
        }
        .test-panel {
            background: #2a2a2a;
            border: 1px solid #4a90e2;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .success { background: rgba(0, 255, 136, 0.2); }
        .error { background: rgba(255, 107, 107, 0.2); }
        .pending { background: rgba(255, 193, 7, 0.2); }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357abd; }
        button:disabled { background: #666; cursor: not-allowed; }
        #console-output {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .connection-log {
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
            padding: 5px;
            margin: 2px 0;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        .stat-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .connection-flow {
            background: #2a2a2a;
            border: 1px solid #ff6b6b;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .flow-step {
            background: #333;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ff6b6b;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª VoidFlow Phase 3 - æ¥ç¶šç®¡ç†IntentåŒ–ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-panel">
        <h2>ğŸ“Š Phase 3 çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="phase3-results">
            <div class="test-result pending">ğŸ”„ ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</div>
        </div>
        <button onclick="runPhase3Tests()">Phase 3ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="testConnectionStart()">æ¥ç¶šé–‹å§‹ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testConnectionComplete()">æ¥ç¶šå®Œäº†ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testConnectionCancel()">æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testConnectionFlow()">æ¥ç¶šãƒ•ãƒ­ãƒ¼ç·åˆãƒ†ã‚¹ãƒˆ</button>
        <button onclick="loadVoidFlowPage()">VoidFlowãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿</button>
        <button onclick="clearConsole()">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ”— æ¥ç¶šãƒ•ãƒ­ãƒ¼å¯è¦–åŒ–</h2>
        <div class="connection-flow" id="connection-flow">
            <div class="flow-step">1ï¸âƒ£ æ¥ç¶šé–‹å§‹ - æœ€åˆã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯</div>
            <div class="flow-step">2ï¸âƒ£ æ¥ç¶šå®Œäº† - 2ç•ªç›®ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯</div>
            <div class="flow-step">3ï¸âƒ£ æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ« - å³ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯åŒã˜ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯</div>
        </div>
        <button onclick="simulateConnectionFlow()">æ¥ç¶šãƒ•ãƒ­ãƒ¼ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h2>
        <div class="stats-panel" id="stats-panel">
            <div class="stat-item">
                <div>æ¥ç¶šé–‹å§‹Intentæ•°</div>
                <div id="connection-start-count">0</div>
            </div>
            <div class="stat-item">
                <div>æ¥ç¶šå®Œäº†Intentæ•°</div>
                <div id="connection-complete-count">0</div>
            </div>
            <div class="stat-item">
                <div>æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«Intentæ•°</div>
                <div id="connection-cancel-count">0</div>
            </div>
            <div class="stat-item">
                <div>ç·Intentæ•°</div>
                <div id="total-intent-count">0</div>
            </div>
        </div>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ–¥ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
        <div id="console-output"></div>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h2>
        <p>ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š</p>
        <ul>
            <li><code>testPhase3.startConnection('plugin1')</code> - æ¥ç¶šé–‹å§‹ãƒ†ã‚¹ãƒˆ</li>
            <li><code>testPhase3.completeConnection('plugin1', 'plugin2')</code> - æ¥ç¶šå®Œäº†ãƒ†ã‚¹ãƒˆ</li>
            <li><code>testPhase3.cancelConnection('user')</code> - æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆ</li>
            <li><code>testPhase3.getConnectionStats()</code> - æ¥ç¶šçµ±è¨ˆç¢ºèª</li>
        </ul>
    </div>

    <script type="module">
        // VoidFlowCoreçµ±åˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { VoidFlowCore } from './voidflow/js/voidflow-core.js'
        import { VoidFlowIntentBridge } from './voidflow/js/intent-bridge.js'
        import { INTENT_TYPES, IntentShortcuts } from './voidflow/js/intent-definitions.js'
        
        let testVoidFlowCore = null
        let testIntentBridge = null
        let connectionStartCount = 0
        let connectionCompleteCount = 0
        let connectionCancelCount = 0
        let totalIntentCount = 0
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
        window.runPhase3Tests = runPhase3Tests
        window.testConnectionStart = testConnectionStart
        window.testConnectionComplete = testConnectionComplete
        window.testConnectionCancel = testConnectionCancel
        window.testConnectionFlow = testConnectionFlow
        window.simulateConnectionFlow = simulateConnectionFlow
        window.loadVoidFlowPage = loadVoidFlowPage
        window.clearConsole = clearConsole
        
        // ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        window.testPhase3 = {
            startConnection: startConnectionTest,
            completeConnection: completeConnectionTest,
            cancelConnection: cancelConnectionTest,
            getConnectionStats: getConnectionStats,
            getSystemStatus: getSystemStatus
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            log('ğŸŒŸ VoidFlow Phase 3ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...')
            
            try {
                // VoidFlowCoreåˆæœŸåŒ–
                testVoidFlowCore = new VoidFlowCore({
                    enableDebug: true,
                    enableStats: true
                })
                
                // Intentç›£è¦–è¨­å®š
                setupConnectionIntentMonitoring()
                
                // Intent BridgeåˆæœŸåŒ–
                testIntentBridge = new VoidFlowIntentBridge(testVoidFlowCore)
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
                window.testVoidFlowCore = testVoidFlowCore
                window.testIntentBridge = testIntentBridge
                
                log('âœ… Phase 3ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–å®Œäº†ï¼')
                updateTestResult('phase3-results', 'âœ… åˆæœŸåŒ–å®Œäº†', 'success')
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats()
                
            } catch (error) {
                log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`)
                updateTestResult('phase3-results', `âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error')
                updateStats()
            }
        })
        
        // Phase 3çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runPhase3Tests() {
            log('ğŸ§ª Phase 3çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹...')
            updateTestResult('phase3-results', 'ğŸ”„ Phase 3ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'pending')
            
            const tests = [
                { name: 'VoidFlowCoreæ¥ç¶šæ©Ÿèƒ½', test: testVoidFlowCoreConnection },
                { name: 'æ¥ç¶šé–‹å§‹Intent', test: testConnectionStartIntent },
                { name: 'æ¥ç¶šå®Œäº†Intent', test: testConnectionCompleteIntent },
                { name: 'æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«Intent', test: testConnectionCancelIntent },
                { name: 'Intentå®šç¾©ç¢ºèª', test: testConnectionIntentDefinitions }
            ]
            
            let passed = 0
            let failed = 0
            
            for (const test of tests) {
                try {
                    log(`ğŸ” ${test.name}ãƒ†ã‚¹ãƒˆé–‹å§‹...`)
                    await test.test()
                    log(`âœ… ${test.name}ãƒ†ã‚¹ãƒˆæˆåŠŸ`)
                    passed++
                } catch (error) {
                    log(`âŒ ${test.name}ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                    failed++
                }
            }
            
            const result = `Phase 3ãƒ†ã‚¹ãƒˆå®Œäº†: ${passed}æˆåŠŸ, ${failed}å¤±æ•—`
            const status = failed === 0 ? 'success' : 'error'
            log(`ğŸ‰ ${result}`)
            updateTestResult('phase3-results', result, status)
            updateStats()
        }
        
        // å€‹åˆ¥ãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testVoidFlowCoreConnection() {
            const features = testVoidFlowCore.getAvailableFeatures()
            if (!features.includes('connection-management')) {
                throw new Error('Connection management feature not available')
            }
        }
        
        async function testConnectionStartIntent() {
            const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.start', {
                sourceId: 'test-plugin-1',
                sourceType: 'plugin',
                cursor: { x: 100, y: 100 },
                connectionMode: 'data'
            })
            connectionStartCount++
            totalIntentCount++
            if (!result || result.status === 'error') {
                throw new Error('Connection start intent failed')
            }
        }
        
        async function testConnectionCompleteIntent() {
            const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.complete', {
                sourceId: 'test-plugin-1',
                targetId: 'test-plugin-2',
                connectionType: 'data-flow'
            })
            connectionCompleteCount++
            totalIntentCount++
            if (!result || result.status === 'error') {
                throw new Error('Connection complete intent failed')
            }
        }
        
        async function testConnectionCancelIntent() {
            const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.cancel', {
                reason: 'user',
                sourceId: 'test-plugin-1'
            })
            connectionCancelCount++
            totalIntentCount++
            if (!result || result.status === 'error') {
                throw new Error('Connection cancel intent failed')
            }
        }
        
        async function testConnectionIntentDefinitions() {
            if (!INTENT_TYPES.UI.CONNECTION.START || 
                !INTENT_TYPES.UI.CONNECTION.COMPLETE || 
                !INTENT_TYPES.UI.CONNECTION.CANCEL) {
                throw new Error('Connection intent definitions not available')
            }
        }
        
        // æ¥ç¶šé–‹å§‹ãƒ†ã‚¹ãƒˆ
        async function testConnectionStart() {
            log('ğŸ”— æ¥ç¶šé–‹å§‹ãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.start', {
                    sourceId: 'connection-test-source',
                    sourceType: 'plugin',
                    cursor: { x: 150, y: 100 },
                    connectionMode: 'data',
                    timestamp: Date.now()
                })
                
                logConnection(`âœ… æ¥ç¶šé–‹å§‹Intenté€ä¿¡æˆåŠŸ`, result)
                connectionStartCount++
                totalIntentCount++
                updateStats()
                
            } catch (error) {
                log(`âŒ æ¥ç¶šé–‹å§‹ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
            }
        }
        
        // æ¥ç¶šå®Œäº†ãƒ†ã‚¹ãƒˆ
        async function testConnectionComplete() {
            log('ğŸ”— æ¥ç¶šå®Œäº†ãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.complete', {
                    sourceId: 'connection-test-source',
                    targetId: 'connection-test-target',
                    connectionType: 'data-flow',
                    metadata: {
                        testConnection: true
                    },
                    timestamp: Date.now()
                })
                
                logConnection(`âœ… æ¥ç¶šå®Œäº†Intenté€ä¿¡æˆåŠŸ`, result)
                connectionCompleteCount++
                totalIntentCount++
                updateStats()
                
            } catch (error) {
                log(`âŒ æ¥ç¶šå®Œäº†ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
            }
        }
        
        // æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆ
        async function testConnectionCancel() {
            log('ğŸ”— æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                const result = await testVoidFlowCore.sendIntent('voidflow.ui.connection.cancel', {
                    reason: 'user-test',
                    sourceId: 'connection-test-source',
                    timestamp: Date.now()
                })
                
                logConnection(`âœ… æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«Intenté€ä¿¡æˆåŠŸ`, result)
                connectionCancelCount++
                totalIntentCount++
                updateStats()
                
            } catch (error) {
                log(`âŒ æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
            }
        }
        
        // æ¥ç¶šãƒ•ãƒ­ãƒ¼ç·åˆãƒ†ã‚¹ãƒˆ
        async function testConnectionFlow() {
            log('ğŸ”— æ¥ç¶šãƒ•ãƒ­ãƒ¼ç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                // ãƒ•ãƒ­ãƒ¼ 1: æ¥ç¶šé–‹å§‹ â†’ å®Œäº†
                log('ğŸ“ ãƒ•ãƒ­ãƒ¼1: æ¥ç¶šé–‹å§‹ â†’ å®Œäº†')
                await testVoidFlowCore.sendIntent('voidflow.ui.connection.start', {
                    sourceId: 'flow-test-1',
                    cursor: { x: 100, y: 50 }
                })
                connectionStartCount++
                totalIntentCount++
                
                await new Promise(resolve => setTimeout(resolve, 500))
                
                await testVoidFlowCore.sendIntent('voidflow.ui.connection.complete', {
                    sourceId: 'flow-test-1',
                    targetId: 'flow-test-2',
                    connectionType: 'data-flow'
                })
                connectionCompleteCount++
                totalIntentCount++
                
                // ãƒ•ãƒ­ãƒ¼ 2: æ¥ç¶šé–‹å§‹ â†’ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                log('ğŸ“ ãƒ•ãƒ­ãƒ¼2: æ¥ç¶šé–‹å§‹ â†’ ã‚­ãƒ£ãƒ³ã‚»ãƒ«')
                await testVoidFlowCore.sendIntent('voidflow.ui.connection.start', {
                    sourceId: 'flow-test-3',
                    cursor: { x: 200, y: 50 }
                })
                connectionStartCount++
                totalIntentCount++
                
                await new Promise(resolve => setTimeout(resolve, 500))
                
                await testVoidFlowCore.sendIntent('voidflow.ui.connection.cancel', {
                    reason: 'user',
                    sourceId: 'flow-test-3'
                })
                connectionCancelCount++
                totalIntentCount++
                
                log('ğŸ‰ æ¥ç¶šãƒ•ãƒ­ãƒ¼ç·åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼')
                updateStats()
                
            } catch (error) {
                log(`âŒ æ¥ç¶šãƒ•ãƒ­ãƒ¼ç·åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
            }
        }
        
        // æ¥ç¶šãƒ•ãƒ­ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function simulateConnectionFlow() {
            log('ğŸ¬ æ¥ç¶šãƒ•ãƒ­ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...')
            
            const steps = [
                { step: '1ï¸âƒ£ æ¥ç¶šé–‹å§‹', delay: 1000 },
                { step: '2ï¸âƒ£ æ¥ç¶šå®Œäº†', delay: 1000 },
                { step: '3ï¸âƒ£ æ–°ã—ã„æ¥ç¶šé–‹å§‹', delay: 1000 },
                { step: '4ï¸âƒ£ æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«', delay: 1000 }
            ]
            
            for (const { step, delay } of steps) {
                log(`ğŸ“ ${step}`)
                await new Promise(resolve => setTimeout(resolve, delay))
            }
            
            log('ğŸ¬ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼')
        }
        
        // VoidFlowãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
        function loadVoidFlowPage() {
            log('ğŸ”— VoidFlowãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...')
            window.location.href = '/voidflow/index-voidcore.html'
        }
        
        // Intentç›£è¦–è¨­å®š
        function setupConnectionIntentMonitoring() {
            const originalSendIntent = testVoidFlowCore.sendIntent.bind(testVoidFlowCore)
            testVoidFlowCore.sendIntent = async function(type, payload) {
                if (type.startsWith('voidflow.ui.connection.')) {
                    logConnection(`ğŸ“¤ æ¥ç¶šIntenté€ä¿¡: ${type}`, payload)
                }
                return originalSendIntent(type, payload)
            }
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function startConnectionTest(sourceId) {
            return await testVoidFlowCore.sendIntent('voidflow.ui.connection.start', {
                sourceId,
                cursor: { x: 100, y: 100 }
            })
        }
        
        async function completeConnectionTest(sourceId, targetId) {
            return await testVoidFlowCore.sendIntent('voidflow.ui.connection.complete', {
                sourceId,
                targetId,
                connectionType: 'data-flow'
            })
        }
        
        async function cancelConnectionTest(reason) {
            return await testVoidFlowCore.sendIntent('voidflow.ui.connection.cancel', {
                reason,
                timestamp: Date.now()
            })
        }
        
        function getConnectionStats() {
            return {
                connectionStart: connectionStartCount,
                connectionComplete: connectionCompleteCount,
                connectionCancel: connectionCancelCount,
                total: totalIntentCount,
                systemStatus: testVoidFlowCore.getSystemStatus()
            }
        }
        
        function getSystemStatus() {
            return testVoidFlowCore.getSystemStatus()
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function log(message) {
            console.log(message)
            const output = document.getElementById('console-output')
            const timestamp = new Date().toLocaleTimeString()
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`
            output.scrollTop = output.scrollHeight
        }
        
        function logConnection(message, data) {
            const output = document.getElementById('console-output')
            const timestamp = new Date().toLocaleTimeString()
            output.innerHTML += `<div class="connection-log">[${timestamp}] ${message}<br><pre>${JSON.stringify(data, null, 2)}</pre></div>`
            output.scrollTop = output.scrollHeight
        }
        
        function updateTestResult(elementId, message, status) {
            const element = document.getElementById(elementId)
            element.innerHTML = `<div class="test-result ${status}">${message}</div>`
        }
        
        function updateStats() {
            document.getElementById('connection-start-count').textContent = connectionStartCount
            document.getElementById('connection-complete-count').textContent = connectionCompleteCount
            document.getElementById('connection-cancel-count').textContent = connectionCancelCount
            document.getElementById('total-intent-count').textContent = totalIntentCount
        }
        
        function clearConsole() {
            document.getElementById('console-output').innerHTML = ''
            log('ğŸ§¹ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢å®Œäº†')
        }
    </script>
</body>
</html>