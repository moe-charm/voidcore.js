<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª VoidFlow Phase 2 - UIæ“ä½œIntentåŒ–ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            background: #1a1a1a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            margin: 20px;
        }
        .test-panel {
            background: #2a2a2a;
            border: 1px solid #4a90e2;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .success { background: rgba(0, 255, 136, 0.2); }
        .error { background: rgba(255, 107, 107, 0.2); }
        .pending { background: rgba(255, 193, 7, 0.2); }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357abd; }
        button:disabled { background: #666; cursor: not-allowed; }
        #console-output {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .intent-log {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4a90e2;
            padding: 5px;
            margin: 2px 0;
        }
        .error-log {
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
            padding: 5px;
            margin: 2px 0;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        .stat-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .canvas-preview {
            width: 300px;
            height: 200px;
            background: #333;
            border: 1px solid #555;
            position: relative;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª VoidFlow Phase 2 - UIæ“ä½œIntentåŒ–ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-panel">
        <h2>ğŸ“Š Phase 2 çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="phase2-results">
            <div class="test-result pending">ğŸ”„ ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</div>
        </div>
        <button onclick="runPhase2Tests()">Phase 2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="testUIElementCreation()">UIè¦ç´ ä½œæˆãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testDragDropIntents()">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testIntentBridge()">Intent Bridgeãƒ†ã‚¹ãƒˆ</button>
        <button onclick="loadVoidFlowPage()">VoidFlowãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿</button>
        <button onclick="clearConsole()">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h2>
        <div class="stats-panel" id="stats-panel">
            <div class="stat-item">
                <div>Intenté€ä¿¡æ•°</div>
                <div id="intent-count">0</div>
            </div>
            <div class="stat-item">
                <div>UIè¦ç´ ä½œæˆæ•°</div>
                <div id="ui-element-count">0</div>
            </div>
            <div class="stat-item">
                <div>ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œæ•°</div>
                <div id="drag-count">0</div>
            </div>
            <div class="stat-item">
                <div>ã‚¨ãƒ©ãƒ¼æ•°</div>
                <div id="error-count">0</div>
            </div>
        </div>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ–¥ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
        <div id="console-output"></div>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ¯ Intentç›£è¦–</h2>
        <button onclick="startIntentTracing()">Intentè¿½è·¡é–‹å§‹</button>
        <button onclick="stopIntentTracing()">Intentè¿½è·¡åœæ­¢</button>
        <div id="intent-monitor"></div>
    </div>
    
    <div class="test-panel">
        <h2>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h2>
        <p>ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š</p>
        <ul>
            <li><code>testPhase2.createTestElement()</code> - ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ</li>
            <li><code>testPhase2.sendTestIntent()</code> - ãƒ†ã‚¹ãƒˆIntenté€ä¿¡</li>
            <li><code>testPhase2.getSystemStatus()</code> - ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</li>
            <li><code>testPhase2.enableIntentBridge()</code> - Intent Bridgeæœ‰åŠ¹åŒ–</li>
        </ul>
    </div>

    <script type="module">
        // VoidFlowCoreçµ±åˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { VoidFlowCore } from './voidflow/js/voidflow-core.js'
        import { VoidFlowIntentBridge } from './voidflow/js/intent-bridge.js'
        import { INTENT_TYPES, IntentShortcuts } from './voidflow/js/intent-definitions.js'
        
        let testVoidFlowCore = null
        let testIntentBridge = null
        let intentCount = 0
        let uiElementCount = 0
        let dragCount = 0
        let errorCount = 0
        let intentTracing = false
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
        window.runPhase2Tests = runPhase2Tests
        window.testUIElementCreation = testUIElementCreation
        window.testDragDropIntents = testDragDropIntents
        window.testIntentBridge = testIntentBridge
        window.loadVoidFlowPage = loadVoidFlowPage
        window.clearConsole = clearConsole
        window.startIntentTracing = startIntentTracing
        window.stopIntentTracing = stopIntentTracing
        
        // ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        window.testPhase2 = {
            createTestElement: createTestElement,
            sendTestIntent: sendTestIntent,
            getSystemStatus: getSystemStatus,
            enableIntentBridge: enableIntentBridge,
            disableIntentBridge: disableIntentBridge
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            log('ğŸŒŸ VoidFlow Phase 2ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...')
            
            try {
                // VoidFlowCoreåˆæœŸåŒ–
                testVoidFlowCore = new VoidFlowCore({
                    enableDebug: true,
                    enableStats: true
                })
                
                // Intentç›£è¦–è¨­å®š
                setupIntentMonitoring()
                
                // Intent BridgeåˆæœŸåŒ–ï¼ˆç„¡åŠ¹çŠ¶æ…‹ï¼‰
                testIntentBridge = new VoidFlowIntentBridge(testVoidFlowCore)
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
                window.testVoidFlowCore = testVoidFlowCore
                window.testIntentBridge = testIntentBridge
                
                log('âœ… Phase 2ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–å®Œäº†ï¼')
                updateTestResult('phase2-results', 'âœ… åˆæœŸåŒ–å®Œäº†', 'success')
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats()
                
            } catch (error) {
                log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`)
                updateTestResult('phase2-results', `âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error')
                errorCount++
                updateStats()
            }
        })
        
        // Phase 2çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runPhase2Tests() {
            log('ğŸ§ª Phase 2çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹...')
            updateTestResult('phase2-results', 'ğŸ”„ Phase 2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'pending')
            
            const tests = [
                { name: 'VoidFlowCoreåŸºæœ¬æ©Ÿèƒ½', test: testVoidFlowCoreBasic },
                { name: 'UI Intenté€å—ä¿¡', test: testUIIntentFlow },
                { name: 'Intentå®šç¾©ç¢ºèª', test: testIntentDefinitions },
                { name: 'Intent BridgeåˆæœŸåŒ–', test: testIntentBridgeInit },
                { name: 'ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', test: testErrorHandling }
            ]
            
            let passed = 0
            let failed = 0
            
            for (const test of tests) {
                try {
                    log(`ğŸ” ${test.name}ãƒ†ã‚¹ãƒˆé–‹å§‹...`)
                    await test.test()
                    log(`âœ… ${test.name}ãƒ†ã‚¹ãƒˆæˆåŠŸ`)
                    passed++
                } catch (error) {
                    log(`âŒ ${test.name}ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                    failed++
                    errorCount++
                }
            }
            
            const result = `Phase 2ãƒ†ã‚¹ãƒˆå®Œäº†: ${passed}æˆåŠŸ, ${failed}å¤±æ•—`
            const status = failed === 0 ? 'success' : 'error'
            log(`ğŸ‰ ${result}`)
            updateTestResult('phase2-results', result, status)
            updateStats()
        }
        
        // å€‹åˆ¥ãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testVoidFlowCoreBasic() {
            if (!testVoidFlowCore || !testVoidFlowCore.isInitialized) {
                throw new Error('VoidFlowCore not initialized')
            }
            const status = testVoidFlowCore.getSystemStatus()
            if (!status.initialized) {
                throw new Error('VoidFlowCore not ready')
            }
        }
        
        async function testUIIntentFlow() {
            const result = await testVoidFlowCore.sendIntent('voidflow.ui.element.create', {
                nodeType: 'test-button',
                position: { x: 100, y: 100 },
                pluginId: 'test-ui-element'
            })
            intentCount++
            if (!result || result.status === 'error') {
                throw new Error('UI Intent flow failed')
            }
        }
        
        async function testIntentDefinitions() {
            if (!window.VoidFlowIntents || !INTENT_TYPES.UI.ELEMENT.CREATE) {
                throw new Error('Intent definitions not available')
            }
        }
        
        async function testIntentBridgeInit() {
            if (!testIntentBridge) {
                throw new Error('Intent Bridge not initialized')
            }
            const stats = testIntentBridge.getStatistics()
            if (!stats.hasOwnProperty('enabled')) {
                throw new Error('Intent Bridge statistics not available')
            }
        }
        
        async function testErrorHandling() {
            try {
                await testVoidFlowCore.sendIntent('invalid.intent.type', {})
                throw new Error('Error handling test failed - should have thrown')
            } catch (error) {
                if (error.message.includes('Unknown')) {
                    // æœŸå¾…é€šã‚Šã®ã‚¨ãƒ©ãƒ¼
                    return
                }
                throw error
            }
        }
        
        // UIè¦ç´ ä½œæˆãƒ†ã‚¹ãƒˆ
        async function testUIElementCreation() {
            log('ğŸ¨ UIè¦ç´ ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                const testElements = [
                    { nodeType: 'button', position: { x: 50, y: 50 } },
                    { nodeType: 'input', position: { x: 200, y: 50 } },
                    { nodeType: 'display', position: { x: 350, y: 50 } }
                ]
                
                for (const element of testElements) {
                    const result = await testVoidFlowCore.sendIntent('voidflow.ui.element.create', {
                        ...element,
                        pluginId: `test-${element.nodeType}-${Date.now()}`
                    })
                    
                    log(`âœ… ${element.nodeType}è¦ç´ ä½œæˆ: ${JSON.stringify(result)}`)
                    intentCount++
                    uiElementCount++
                }
                
                log('ğŸ‰ UIè¦ç´ ä½œæˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼')
                updateStats()
                
            } catch (error) {
                log(`âŒ UIè¦ç´ ä½œæˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                errorCount++
                updateStats()
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
        async function testDragDropIntents() {
            log('ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—Intentãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                const testElementId = 'drag-test-element'
                
                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹Intent
                await testVoidFlowCore.sendIntent('voidflow.ui.element.move', {
                    elementId: testElementId,
                    action: 'drag-start',
                    startPosition: { x: 100, y: 100 },
                    isDragging: true
                })
                log('âœ… ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹Intenté€ä¿¡æˆåŠŸ')
                intentCount++
                
                // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•Intent
                await testVoidFlowCore.sendIntent('voidflow.ui.element.move', {
                    elementId: testElementId,
                    action: 'drag-move',
                    newPosition: { x: 150, y: 120 },
                    isDragging: true
                })
                log('âœ… ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•Intenté€ä¿¡æˆåŠŸ')
                intentCount++
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†Intent
                await testVoidFlowCore.sendIntent('voidflow.ui.element.move', {
                    elementId: testElementId,
                    action: 'drag-end',
                    finalPosition: { x: 200, y: 150 },
                    isDragging: false
                })
                log('âœ… ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†Intenté€ä¿¡æˆåŠŸ')
                intentCount++
                dragCount++
                
                log('ğŸ‰ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—Intentãƒ†ã‚¹ãƒˆå®Œäº†ï¼')
                updateStats()
                
            } catch (error) {
                log(`âŒ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—Intentãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                errorCount++
                updateStats()
            }
        }
        
        // Intent Bridgeãƒ†ã‚¹ãƒˆ
        async function testIntentBridge() {
            log('ğŸŒ‰ Intent Bridgeãƒ†ã‚¹ãƒˆé–‹å§‹...')
            
            try {
                if (!testIntentBridge) {
                    throw new Error('Intent Bridge not available')
                }
                
                const stats = testIntentBridge.getStatistics()
                log(`ğŸ“Š Intent Bridgeçµ±è¨ˆ: ${JSON.stringify(stats, null, 2)}`)
                
                // ä¸€æ™‚çš„ã«æœ‰åŠ¹åŒ–ã—ã¦ãƒ†ã‚¹ãƒˆ
                testIntentBridge.enable()
                log('âœ… Intent Bridgeæœ‰åŠ¹åŒ–æˆåŠŸ')
                
                await new Promise(resolve => setTimeout(resolve, 1000))
                
                testIntentBridge.disable()
                log('âœ… Intent Bridgeç„¡åŠ¹åŒ–æˆåŠŸ')
                
                log('ğŸ‰ Intent Bridgeãƒ†ã‚¹ãƒˆå®Œäº†ï¼')
                
            } catch (error) {
                log(`âŒ Intent Bridgeãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`)
                errorCount++
                updateStats()
            }
        }
        
        // VoidFlowãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
        function loadVoidFlowPage() {
            log('ğŸ”— VoidFlowãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...')
            window.location.href = '/voidflow/index-voidcore.html'
        }
        
        // Intentç›£è¦–è¨­å®š
        function setupIntentMonitoring() {
            // VoidFlowCoreã®Intenté€ä¿¡ã‚’ãƒ•ãƒƒã‚¯
            const originalSendIntent = testVoidFlowCore.sendIntent.bind(testVoidFlowCore)
            testVoidFlowCore.sendIntent = async function(type, payload) {
                if (intentTracing) {
                    logIntent(`ğŸ“¤ Intenté€ä¿¡: ${type}`, payload)
                }
                return originalSendIntent(type, payload)
            }
        }
        
        // Intentè¿½è·¡é–‹å§‹/åœæ­¢
        function startIntentTracing() {
            intentTracing = true
            log('ğŸ” Intentè¿½è·¡é–‹å§‹')
            updateIntentMonitor('ğŸŸ¢ Intentè¿½è·¡ä¸­...')
        }
        
        function stopIntentTracing() {
            intentTracing = false
            log('ğŸ” Intentè¿½è·¡åœæ­¢')
            updateIntentMonitor('â­• Intentè¿½è·¡åœæ­¢')
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function createTestElement() {
            return await testVoidFlowCore.sendIntent('voidflow.ui.element.create', {
                nodeType: 'test',
                position: { x: Math.random() * 300, y: Math.random() * 200 },
                pluginId: `debug-element-${Date.now()}`
            })
        }
        
        async function sendTestIntent() {
            return await testVoidFlowCore.sendIntent('voidflow.system.status')
        }
        
        function getSystemStatus() {
            return testVoidFlowCore.getSystemStatus()
        }
        
        function enableIntentBridge() {
            testIntentBridge.enable()
            log('ğŸ“¡ Intent Bridgeæœ‰åŠ¹åŒ–')
        }
        
        function disableIntentBridge() {
            testIntentBridge.disable()
            log('ğŸ“¡ Intent Bridgeç„¡åŠ¹åŒ–')
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function log(message) {
            console.log(message)
            const output = document.getElementById('console-output')
            const timestamp = new Date().toLocaleTimeString()
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`
            output.scrollTop = output.scrollHeight
        }
        
        function logIntent(message, payload) {
            const output = document.getElementById('console-output')
            const timestamp = new Date().toLocaleTimeString()
            output.innerHTML += `<div class="intent-log">[${timestamp}] ${message}<br><pre>${JSON.stringify(payload, null, 2)}</pre></div>`
            output.scrollTop = output.scrollHeight
        }
        
        function updateTestResult(elementId, message, status) {
            const element = document.getElementById(elementId)
            element.innerHTML = `<div class="test-result ${status}">${message}</div>`
        }
        
        function updateIntentMonitor(message) {
            const element = document.getElementById('intent-monitor')
            element.innerHTML = `<div class="test-result pending">${message}</div>`
        }
        
        function updateStats() {
            document.getElementById('intent-count').textContent = intentCount
            document.getElementById('ui-element-count').textContent = uiElementCount
            document.getElementById('drag-count').textContent = dragCount
            document.getElementById('error-count').textContent = errorCount
        }
        
        function clearConsole() {
            document.getElementById('console-output').innerHTML = ''
            log('ğŸ§¹ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢å®Œäº†')
        }
    </script>
</body>
</html>